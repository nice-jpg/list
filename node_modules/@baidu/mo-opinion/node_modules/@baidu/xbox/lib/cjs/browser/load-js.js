"use strict";
/**
 * js 加载器
 * @file Created on Thu Nov 22 2018
 * @author wangyongqing <wangyongqing01@baidu.com>
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.loadJS = void 0;
var guid_1 = require("../guid");
var is_1 = require("../is");
var json2query_1 = require("../json2query");
var load_file_1 = require("./load-file");
/**
 * 加载 JS
 *
 * @param param 参数
 * @example
 *  loadjs({
 *      url,
 *      data,
 *      async,
 *      timeout,
 *      before,
 *      success,
 *      error,
 *      jsonpCallback,
 *      jsonpCallbackName // 传给server的回调函数的名字
 *  })
 */
function loadJS(_a) {
    var _b;
    var _c = _a.url, url = _c === void 0 ? '' : _c, data = _a.data, async = _a.async, _d = _a.timeout, timeout = _d === void 0 ? 2e4 : _d, before = _a.before, success = _a.success, error = _a.error, jsonpCallback = _a.jsonpCallback, jsonpCallbackName = _a.jsonpCallbackName;
    if (typeof data === 'object') {
        data = (0, json2query_1.json2query)(data);
    }
    if (data) {
        url += (url.includes('?') ? '&' : '?') + data;
    }
    url = url.replace(/[&?]{1,2}/, '?');
    var callbackName = (0, is_1.isFunction)(jsonpCallback)
        ? jsonpCallback()
        : (0, is_1.isString)(jsonpCallback)
            ? jsonpCallback
            : '_boxjsonp' + (0, guid_1.guid)();
    var originalCallback = window[callbackName];
    // 返回的数据
    var responseData = null;
    var cb = function (e, p) {
        var _a;
        if (e) {
            error && error(e, p);
        }
        else {
            success && success(responseData);
        }
        // window[callbackName] = originalCallback;
        Object.assign(window, (_a = {},
            _a[callbackName] = originalCallback,
            _a));
        if (responseData && (0, is_1.isFunction)(originalCallback)) {
            originalCallback(responseData);
        }
        originalCallback = responseData = undefined;
    };
    // window[callbackName] = (...args) => {
    //     responseData = args;
    // };
    Object.assign(window, (_b = {},
        _b[callbackName] = function (data) {
            responseData = data;
        },
        _b));
    // 当data的某个属性的值恰好以'?'开头，比如data:{content:'?', callback:'?'}，经过json2query后'content=?&callback=?'
    // 此时不能直接替换/=\?/，可根据传参优先处理
    if (jsonpCallbackName) {
        url += '&' + jsonpCallbackName + '=' + callbackName;
    }
    else if (url.includes('=?')) {
        url = url.replace('=?', '=' + callbackName);
    }
    (0, load_file_1.loadFile)(url, cb, { timeout: timeout, async: async, before: before });
}
exports.loadJS = loadJS;
