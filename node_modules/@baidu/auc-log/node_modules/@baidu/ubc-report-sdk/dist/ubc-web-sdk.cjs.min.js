"use strict";require("core-js/modules/es6.array.index-of"),require("core-js/modules/es6.regexp.match"),require("core-js/modules/es6.regexp.split"),require("core-js/modules/es6.regexp.constructor"),require("core-js/modules/es6.array.is-array"),require("core-js/modules/es6.object.assign"),require("core-js/modules/es6.array.map"),require("core-js/modules/es6.array.for-each"),require("core-js/modules/es6.date.now"),require("core-js/modules/es6.array.find");var commandRegex=/^(?:(\w+)\.)?(?:(\w+)\.)?(\w+)$/;function Command(e){var t=commandRegex.exec(e[0]);if(null==t||4!==t.length)throw"UBC SDK error inputs";if(this.trackerName=t[1]||"t0",this.pluginName=t[2]||"",this.methodName=t[3],this.fields=[].slice.call(e,1),this.isCreateCommand="init"===this.methodName,this.isConfigCommand="config"===this.methodName,this.isEventCommand="event"===this.methodName||"pv"===this.methodName,this.isTimingCommand="timing"===this.methodName,!this.methodName)throw"UBC SDK methodName can not be empty!";if(this.isCreateCommand&&!this.fields[0])throw"UBC SDK serverId can not be empty!"}var ua=window.navigator.userAgent,IS_LITE_BOX=/ (lite|info) baiduboxapp\//i.test(ua),IS_KANDUODUO_BOX=/ mission baiduboxapp\//i.test(ua),IS_BOX=/ baiduboxapp\//i.test(ua)&&!IS_LITE_BOX&&!IS_KANDUODUO_BOX,isHTTPS=function(){return"https:"===document.location.protocol},transformInput=function(e,t){if(!Array.isArray(e)||!Array.isArray(t))return{};for(var i={},n=Math.min(e.length+1,t.length),o=0;o<n;o++)if("object"==typeof t[o])for(var r in i[e[o]]={},t[o])t[o].hasOwnProperty(r)&&(i[e[o]][r]=t[o][r]);else o<e.length&&(i[e[o]]=t[o]);return i};function getQueryParams(e,t){void 0===t&&(t=window.location.href);var i=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i");if(t.split("?")[1]){var n=t.split("?")[1].match(i);return null!=n?decodeURIComponent(n[2]):null}return null}function stringify(e){if(void 0===e&&(e={}),!e)return"";var t="";for(var i in e)if(e.hasOwnProperty(i)){var n=e[i];null==n?n="":"object"==typeof n&&(n=JSON.stringify(n)),t+="&"+encodeURIComponent(i)+"="+encodeURIComponent(n)}return t.slice(1)}function renderUrl(e,t){return void 0===e&&(e=""),void 0===t&&(t={}),e+(~e.indexOf("?")?"&":"?")+stringify(t)}function isObject(e){var t=typeof e;return"function"===t||!!e&&"object"===t}function isBoolean(e){return!0===e||!1===e}function isFunction(e){return"function"==typeof e}function loadScript(e){if(e){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=e;var i=document.getElementsByTagName("script")[0];i.parentNode.insertBefore(t,i)}}function noop(){}var MethodQueue={cmdQueue:[],init:function(){MethodQueue.cmdQueue=[]},run:function(e){var t=e.map(function(e){return MethodQueue.toCommands.apply(MethodQueue,[e])}),i=MethodQueue.cmdQueue.concat(t);for(MethodQueue.cmdQueue=[];i.length>0;)MethodQueue.runCommand.apply(this,[i[0]])&&MethodQueue.cmdQueue.push(i[0]),i.shift()},toCommands:function(e){return new Command(e)},runCommand:function(e){if(e.isCreateCommand)this.create.apply(this,[e.trackerName].concat(e.fields));else if(e.isConfigCommand){var t=this.getByName(e.trackerName),i=e.fields[0];for(var n in i)i.hasOwnProperty(n)&&(isObject(i[n])?t.set(n,Object.assign({},t.get(n),i[n])):t.set(n,i[n]))}else if(e.isEventCommand){var o=this.getByName(e.trackerName);o.send.call(o,{type:"event",fields:e.fields})}else if(e.isTimingCommand){var r=this.getByName(e.trackerName),a=e.fields[0],s=[].slice.call(e.fields,1);"start"===a?r.regestTimingReportor(s):"end"===a&&r.endTimingReportor(s)}}};MethodQueue.init();var serverUrls={http:"http://m.baidu.com/tcbox?action=pblog",https:"https://mbd.baidu.com/tcbox?action=pblog"},pblogUrlProtocol=serverUrls[isHTTPS()?"https":"http"],testPblogUrlProtocol="http://bjyz-mco-searchbox201609-m12xi3-044.bjyz.baidu.com:8080/tcbox?action=pblog",ztboxUrlProtocol="https://mbd.baidu.com/ztbox?action=zpblog",testZtboxUrlProtocol="http://bjyz-mco-searchbox201609-m12xi3-044.bjyz.baidu.com:8080/ztbox?action=zpblog",baiduTongJiSDKUrl="https://hm.baidu.com/hm.js",createImg=function(e){var t=document.createElement("img");return t.width=1,t.height=1,t.src=e,t},callbackWaitingTime=100;function imgPing(e,t,i,n){e=renderUrl(e,{data:t});var o=createImg(e),r=!1;setTimeout(function(){i&&!r&&(i(n),r=!0)},callbackWaitingTime),o.onload=o.onerror=function(){o=null,i&&!r&&(i(n),r=!0)}}function beaconSend(e,t,i,n){e=renderUrl(e,{data:t}),window.navigator.sendBeacon(e),i(n)}function smartSend(e,t,i,n,o){return void 0===i&&(i=noop),void 0===n&&(n=0),"function"==typeof window.navigator.sendBeacon&&(o.model.useSendBeacon&&0===n||1===n)?beaconSend(e,t,i,o):imgPing(e,t,i,o)}var hidden,visibilityChange,defaultVersion="1.0",defaultAppid="1",defaultCateid="99",defaultActiontype="0",defaultFrom="act",DefaultDuration=3,eventArgsInputPattern=["type","value","ext"];function Tracker(e){(this.model={},setBasicConfig(this.model,e),this.get("isBaiduTongJi"))&&(window._hmt=window._hmt||[],loadScript(baiduTongJiSDKUrl+"?"+this.get("baiduTongJiId")));this.get("autoPvTrack")&&this.send({type:"event",fields:["pageAutoPv"]}),this.get("autoTimingTrack")&&this.regestTimingReportor(["pageAutoTiming"])}function generateEventData(e,t){var i={cateid:e.cateid,actiondata:{id:e.trackerId,type:"0",timestamp:Date.now(),content:{page:t.page||e.page,source:e.source,from:e.from,type:t.type,value:t.value,ext:t.ext}}};return"1.0"===e.version&&(i.actiondata.abtest=e.abtest,i.actiondata.inBox=e.inBox,i.actiondata.network=e.network,i.appid=e.appid,i.actiontype=e.actiontype),i}function generateDurationData(e,t){var i={cateid:e.cateid,actiondata:{id:e.timingId,type:"1",timestamp:Date.now(),starttime:t.starttime,content:{duration:e.duration,option:{page:e.page,source:e.source,from:e.from,type:t.type,value:t.value,ext:t.ext}}}};return"1.0"===e.version&&(i.actiondata.abtest=e.abtest,i.actiondata.inBox=e.inBox,i.actiondata.network=e.network,i.appid=e.appid,i.actiontype=e.actiontype),i}function setBasicConfig(e,t){e.trackerName=t.trackerName,e.trackerId=t.trackerId||"",e.timingId=t.config&&t.config.timingId||"",e.useSendBeacon=t.config&&t.config.useSendBeacon||!1,e.version=t.config&&t.config.version||defaultVersion,t.config&&isBoolean(t.config.testMode)?e.testMode=t.config.testMode:e.testMode=!1,e.testUrl=t.config&&t.config.testUrl||"",t.config&&isBoolean(t.config.autoPvTrack)?e.autoPvTrack=t.config.autoPvTrack:e.autoPvTrack=!1,t.config&&isBoolean(t.config.autoTimingTrack)?e.autoTimingTrack=t.config.autoTimingTrack:e.autoTimingTrack=!1,e.queryParams=t.config&&t.config.queryParams||{},e.version&&(e.queryParams.v=e.version),e.appid=t.config&&t.config.appid||defaultAppid,e.cateid=t.config&&t.config.cateid||defaultCateid,e.actiontype=t.config&&t.config.actiontype||defaultActiontype,e.from=t.config&&t.config.from||defaultFrom,e.duration=t.config&&t.config.duration||DefaultDuration,e.source=t.config&&t.config.source||getQueryParams("idfrom")||"",e.inBox=IS_BOX?"1":"0",e.abtest=t.config&&t.config.abtest||"",e.network=t.config&&t.config.network||"",e.page=t.config&&t.config.page||window.location.hostname+window.location.pathname,e.baiduTongJiId=t.config&&t.config.baiduTongJiId,e.isBaiduTongJi=!(!t.config||!t.config.baiduTongJiId),e.timingTasks=[]}function regestPageVisibilityEvent(e){void 0!==document.addEventListener&&void 0!==hidden&&document.addEventListener(visibilityChange,function(){e.getAll().forEach(function(e){var t=e.get("timingTasks");Array.isArray(t)&&(document[hidden]?e.stopAllTimingReportor():e.startAllTimingReportor())})},!1)}Tracker.prototype.set=function(e,t){this.model[e]=t},Tracker.prototype.get=function(e){return this.model[e]},Tracker.prototype.send=function(e){var t,i,n,o=e.type,r=e.fields,a=0;if("event"===o){if(r&&isObject(r[0])?(n=r[0],isFunction(r[1])&&(t=r[1])):n=transformInput(eventArgsInputPattern,r),i=generateEventData(this.model,n),n.useSendBeacon&&(a=n.useSendBeacon),this.get("isBaiduTongJi")){var s=i.actiondata.content||{},c=s.page,d=s.type,u=s.value;window._hmt.push(["_trackEvent",c,d,u])}}else"timing"===o&&(i=generateDurationData(this.model,r));var m=this.get("testMode")?testPblogUrlProtocol:pblogUrlProtocol;"2.0"===this.model.version&&(m=this.get("testMode")?testZtboxUrlProtocol:ztboxUrlProtocol,m=renderUrl(m=this.model.testUrl||m,this.model.queryParams)),smartSend.apply(this,[m,i,t,a,this])},Tracker.prototype.regestTimingReportor=function(e){var t=this;if(void 0===e&&(e=[]),!this.get("timingId"))throw"timing ID is required!";var i=this.get("timingTasks"),n=this.get("duration");e=transformInput(eventArgsInputPattern,e);var o=i.find(function(t){return t.eventName===e.type});if(e.starttime=Date.now(),!o){this.send({type:"timing",fields:e});var r=setInterval(function(){t.send({type:"timing",fields:e})},1e3*n);i.push({timingIntevalId:r,isReporting:!0,eventName:e.type,fields:e})}},Tracker.prototype.stopAllTimingReportor=function(){this.get("timingTasks").forEach(function(e){e.isReporting=!1,clearInterval(e.timingIntevalId)})},Tracker.prototype.startAllTimingReportor=function(){var e=this,t=this.get("timingTasks"),i=this.get("duration");t.forEach(function(t){t.isReporting=!0,t.fields.starttime=Date.now(),e.send({type:"timing",fields:t.fields}),t.timingIntevalId=setInterval(function(){e.send({type:"timing",fields:t.fields})},1e3*i)})},Tracker.prototype.endTimingReportor=function(e){var t=this;e=transformInput(eventArgsInputPattern,e);var i=this.get("timingTasks"),n=[];i.forEach(function(i){var o=i.timingIntevalId;i.eventName===e.type?clearInterval(o):n.push(i),t.set("timingTasks",n)})},Tracker.prototype.removeAllTimingReportor=function(){var e=this.get("timingTasks");e.forEach(function(e){clearInterval(e.timingIntevalId)}),e=[]},void 0!==document.hidden?(hidden="hidden",visibilityChange="visibilitychange"):void 0!==document.msHidden?(hidden="msHidden",visibilityChange="msvisibilitychange"):void 0!==document.webkitHidden?(hidden="webkitHidden",visibilityChange="webkitvisibilitychange"):void 0!==document.baiduboxappvisibilitychange&&(hidden="webkitHidden",visibilityChange="webkitvisibilitychange");var UBCReportObject="ubc",UBCtrackers=[],UBCtrackerMap={},trackerCreateMapFields=["trackerName","trackerId","config"];function UBC(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];MethodQueue.run.call(window[UBCReportObject],[t])}UBC.create=function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=transformInput(trackerCreateMapFields,[].slice.call(t)),o=n.trackerName;if(UBCtrackerMap[o])return UBCtrackerMap[o];if(UBCtrackers.find(function(e){return e.get("trackerId")===n.trackerId}))throw"multi tracker serverId can not be same";var r=new Tracker(n);return UBCtrackerMap[o]=r,UBCtrackers.push(r),r},UBC.remove=function(e){for(var t=UBCtrackers.length,i=0;i<t;i++)if(UBCtrackers[i][e]===e){UBCtrackers.splice(i,1),UBCtrackerMap[e]=null;break}},UBC.main=function(){var e=window[UBCReportObject],t=e&&e.q;e&&"function"==typeof e.getAll&&(UBC=window[UBCReportObject]),Array.isArray(t)&&(MethodQueue.run.apply(UBC,[t]),e.q=[]),UBC.startTime=e&&e.l||1*new Date,UBC.loaded=!0,window[UBCReportObject]=UBC},UBC.getByName=function(e){return UBCtrackerMap[e]},UBC.getAll=function(){return UBCtrackers.slice()},UBC.main(),regestPageVisibilityEvent(UBC);var ubc=UBC;module.exports=ubc;
