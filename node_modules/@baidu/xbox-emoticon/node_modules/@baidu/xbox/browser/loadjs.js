/**
 * js 加载器
 * @module browser
 * @file Created on Thu Nov 22 2018
 * @author wangyongqing <wangyongqing01@baidu.com>
 */
import guid from '../guid';
import json2Query from '../json2query';
import {isType} from '../type';
import loadFile from './load-file';
function isFunction(fn) {
    return isType(fn, 'function');
}
/**
 * @function loadjs
 * @param {object} param - 参数
 * @example
 * loadjs({
 *  url,
 * before,
 * success,
 * error,
 * timeout,
 * async,
 * data,
 * jsonpCallback,
 * jsonpCallbackName // 传给server的回调函数的名字
 * })
 */
export default function loadJS({url, before, success, error, timeout = 2e4, async, data, jsonpCallback, jsonpCallbackName}) {
    if (typeof data === 'object') {
        data = json2Query(data);
    }
    if (data) {
        url += (url.indexOf('?') === -1 ? '?' : '&') + data;
    }
    url = url.replace(/[&?]{1,2}/, '?');

    let callbackName = (isFunction(jsonpCallback) ? jsonpCallback() : jsonpCallback) || '_boxjsonp' + guid();
    let originalCallback = window[callbackName];
    // 返回的数据
    let responseData;
    let cb = (e, p) => {
        if (e) {
            error(e, p);
        } else {
            success(responseData && responseData[0]);
        }

        window[callbackName] = originalCallback;
        if (responseData && isFunction(originalCallback)) {
            originalCallback(responseData[0]);
        }

        originalCallback = responseData = undefined;
    };

    window[callbackName] = (...args) => {
        responseData = args;
    };

    // 当data的某个属性的值恰好以'?'开头，比如data:{content:'?', callback:'?'}，经过json2Query后'conntent=?&callbakc=?'
    // 此时不能直接替换/=\?/，可根据传参优先处理
    if (jsonpCallbackName) {
        url += '&' + jsonpCallbackName + '=' + callbackName;
    } else if (/=\?/.test(url)) {
        url = url.replace(/=\?/, '=' + callbackName);
    }
    loadFile(url, cb, {timeout, async, before});
}
