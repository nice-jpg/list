# error-log v1.0

内容生态用户增长前端**H5**错误上报

[设计文档](http://agroup.baidu.com/share/md/51325d7cbfa444da9caf3b0e51d66e5d)

[小程序错误日志上报戳这里](http://agroup.baidu.com/share/md/48e0d4a867cc42f7b9d77c57b54d2d0e)

## 背景

前端有些情况发无法复现用户错误，可以在上报之后查到，并能够线上预警及时解决重大bug。

## 开发
1. 编码
    * 根目录npm link，把本地npm包链接到全局
    * 进入test目录，npm link @baidu/ug-error-log，更改本地包链接地址
    * test目录，npm run dev启动测试服务
2. git add .
3. npm run commit
4. git gpush

## 发布
1. v1.0版本确保所有commit已合入v1.0.0分支
2. npm run version 生成changelog，新版本号
3. git gpush
4. npm run release 打tag，发包

## API说明
>**H5ErrLog.init**

入参

|参数 | 类型 | 说明 | 默认值 |备注|
|---|---|---|---|---|
|app|string|业务标识|''|<font color=red>**必填**</font>|
|url|string|上报地址|'https://activity.baidu.com/activity/felog/error'|一般不用改|
|watch|boolean|监听页面错误，自动上报|true|一般不用改|

>**H5ErrLog.send**

入参

|参数 | 类型 | 说明 | 默认值 |备注  |
|---|---|---|---|---|
|errInfo|Object|错误信息|{level: 'info', type: '-', content: '-', ext: {errmsg: ''}}|第一个参数|
|errInfo.level|string|错误等级|'info'|'info/error'，可以自定义|
|errInfo.type|string|错误类型|''|'net/app/api/'，可以自定义|
|errInfo.content|string|错误信息|''|Error对象stringify|
|errInfo.ext|object|额外信息对象|\{errmsg:''\}|自定义的错误额外信息|
|errInfo.ext.errmsg|string|额外信息|''|自定义的错误额外信息|
|useSendbeacon|boolean|是否使用Sendbeacon发送日志|false|第二个参数，通常用在页面unload时发送日志，如果浏览器不支持则使用图片请求|
> <font color="red">**注意：**</font>**errInfo中可以自定义字段，但是需要提前和[@zimei](baidu://message/?id=suesue1206)商定要加的字段，不然es无法正常入库**

## 示例

提供了两种方式使用

> <font color=red>注意：</font>自动监听页面数据使用的是addEventListener方法，所以请确保init方法只执行了一次(watch为true情况)，否则会触发多次错误打点。

1. (推荐) 默认导入为new好的实例，直接init，send就好，缺点是不能全局共享，每次引入都是一个全新的实例

```javascript
    import H5ErrLogInstance from '@baidu/ug-error-log';
    // 初始化并传入配置
    // 默认配置 {
    //     // 业务标识，必填
    //     app: '',
    //     // 上报地址，一般不用改
    //     url: 'https://activity.baidu.com/activity/felog/error',
    //     // 监听页面错误(window下的error，unhandledrejection)，自动上报，一般不用改
    //     watch: true
    // }

    H5ErrLogInstance.init({
        app: 'error-log-test'
    });

    // 手动上报
    H5ErrLogInstance.send({
        // 错误等级，可自定义，默认 info
        level: 'error',
        // 错误类型，可自定义，默认 -
        type: 'api',
        // 错误内容
        content: (new Error('test error')).toString(),
        // 额外信息
        ext: {
            errmsg: '额外信息'
        }
    });
    // 使用sendBeacon上报
    H5ErrLogInstance.send({
        // 错误等级，可自定义，默认 info
        level: 'error',
        // 错误类型，可自定义，默认 -
        type: 'api',
        // 错误内容
        content: (new Error('test error')).toString(),
        // 额外信息
        ext: {
            errmsg: '额外信息'
        }
    }, true);

```

2. 也可以引入构造函数，自己new，init，send，用户可以自行二次封装导出，全局共享，为什么不在new时就传递参数，因为想保证两种方法的使用一致性。

```javascript
    import {H5ErrLog} from '@baidu/ug-error-log';
    // 初始化并传入配置
    // 默认配置 {
    //     // 业务标识，必填
    //     app: '',
    //     // 上报地址，一般不用改
    //     url: 'https://activity.baidu.com/activity/felog/error',
    //     // 监听页面错误(window.onerror)，自动上报，一般不用改
    //     watch: true
    // }
    let errorLog = new H5ErrLog();

    errorLog.init({
        app: 'error-log-test'
    });

    // 手动上报
    errorLog.send({
        // 错误等级，可自定义，默认 info
        level: 'error',
        // 错误类型，可自定义，默认 -
        type: 'api',
        // 错误内容
        content: (new Error('test error')).toString(),
        // 额外信息
        ext: {
            errmsg: '额外信息'
        }
    });
    // 使用sendBeacon上报
    errorLog.send({
        // 错误等级，可自定义，默认 info
        level: 'error',
        // 错误类型，可自定义，默认 -
        type: 'api',
        // 错误内容
        content: (new Error('test error')).toString(),
        // 额外信息
        ext: {
            errmsg: '额外信息'
        }
    }, true);

```