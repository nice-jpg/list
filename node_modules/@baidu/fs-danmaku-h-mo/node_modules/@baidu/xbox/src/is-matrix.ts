/**
 * @file 判断是不是矩阵app，符合新的规范，规范地址：
 * @link http://agroup.baidu.com/share/md/0d6d1cc6b1c7417e8071057fb436001b
 * @author wangyongqing <wangyongqing01@baidu.com>
 */

import {UA} from './ua';

/**
 * 是否手百矩阵产品，需要符合新的 UA 规范
 *
 * @param [subName=''] 手百矩阵产品标识，取值如：''|'youjia'
 * @param ua 传入的 userAgent，如果不传则取 navigator.userAgent
 * @return 判断结果
 * @example
 * isMatrix(): 判断属于 lite info 这类老的矩阵APP
 * isMatrix(false): 判断是新的 matrix 格式，即 youjia 这类新的矩阵APP，而不是 lite info 这类老的矩阵APP
 * isMatrix('lite'): 判断是否 lite info 这类老的矩阵APP
 * isMatrix('youjia'): 判断是否 youjia 这类某个新的矩阵APP
 *
 * Android Webview 示例：
 *      Mozilla/5.0 (Linux; Android 8.0.0; MHA-AL00 Build/HUAWEIMHA-AL00; wv)
 *      + AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/63.0.3239.83 Mobile Safari/537.36
 *      + T7/11.16 light/1.0 bdapp/1.0 (youjia; youjia) youjia/1.0.1 (Baidu; P1 8.0.0)
 * NA 网络库：
 *      Dalvik/2.1.0 (Linux; U; Android 8.0.0; MHA-AL00 Build/HUAWEIMHA-AL00) okhttp/3.11.0
 *      + bdapp/1.0 (youjia; youjia) youjia/1.0.1 (Baidu; P1 8.0.0)
 * iOS Webview 示例：
 *      Mozilla/5.0 (iPhone; CPU iPhone OS 13_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko)
 *      + Mobile/15E148 main/1.0 SP-engine/2.14.0 NABar/1.0 bdapp/1.0 (youjia; youjia) youjia/1.0.1 (Baidu; P2 13.3)
 * NA 网络库：
 *      Mozilla/5.0 (iPhone; CPU iPhone OS 13_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko)
 *      + Mobile/15E148 bdapp/1.0 (youjia; youjia) youjia/1.0.1 (Baidu; P2 13.3)
 */
export function isMatrix(subName: string | false = '', ua = UA) {
    if (subName === 'main') {
        subName = '';
    }
    const matrixUaExp = /\bbdapp\/\d+\.\d+\s+\((\w+);\s*(\w+)\)/;

    if (subName === '') {
        // isMatrix(): 判断属于 lite info 这类老的矩阵APP
        const m = /\s(lite|pro|info|mission)\sbaiduboxapp\//.exec(ua);
        if (m) {
            return true;
        }
        // 只判断bdapp/1.0
        if (/\bbdapp\/\d+\.\d+\s/.test(ua)) {
            return true;
        }
    }
    else if (subName === false) {
        // isMatrix(false): 判断是新的 matrix 格式，即 youjia 这类，不包含 lite info 这类
        const m = matrixUaExp.exec(ua);
        if (m && m[1]) {
            return true;
        }
    }
    else if (new RegExp(`\\s${subName}\\sbaiduboxapp\/`).test(ua)) {
        // isMatrix('lite'): 判断是否 lite info 这类老的矩阵APP
        return true;
    }
    else {
        // isMatrix('youjia'): 判断是否 youjia 这类新的矩阵APP
        const m = matrixUaExp.exec(ua);
        if (m && m[1] && m[1] === subName) {
            return true;
        }
    }

    return false;
}
