# boxx

适用于百度 APP 及相关矩阵 APP 的前端端能力调起 SDK， 基于[描述表](https://github.com/ecomfe/js-native/blob/master/doc/description.md)生成对应的端能力 API ，底层基于 [JS-Native](https://github.com/ecomfe/js-native) 库实现，支持的端能力统一维护在 [ES 平台](http://es.baidu-int.com/#/apilist/allList)。

## 如何使用

### FE 同学

#### 1. 机制引入

boxx 在百度 APP 主版本 12.16 以下及所有矩阵 APP 里需要依赖兜底描述表驱动， 因此需要在页面内统一引入。

目前已在：

- 搜索结果页： 主模板、阿拉丁卡片
- feed 页面
- 视觉搜索结果页

等页面引入此机制， 相关业务同学直接使用即可。

机制引入方式：

```javascript
// 引入 boxx
import boxx from '@baidu/boxx';
// 引入 兜底描述表， 包含 ios 和 android 双端， 实际使用时可以区分下操作系统注入， 减小体积
import searchDescriptions from  '@baidu/boxx/dist/searchDescription.json';

// 仅在低版本下需要兜底描述表， 可以通过和端的联动实验来配置
if (needDefaultDescription) {
    boxx.setDefaultDescriptions(searchDescriptions);
}

// 收集错误， 可以用来加监控

// api 缺失， 使用 boxx.call 方式调用不支持的端能力时会触发
boxx.on('error:api-missed', function (err) {
    // err: {
    //     name: 'ApiMissedError';
    //     message: string;
    //     stack: string;
    //     api: string; // api 名称， 比如 'a.b'
    // }
});

// 调用端能力时参数错误
boxx.on('error:arg-invalid', function (err) {
    // err: {
    //     name: 'ArgInvalidError';
    //     message: string;
    //     stack: string;
    //     api: string; // 'a.b'
    //     arg: string; // 'arg1'
    // }
});
```

#### 2. 业务开发

业务同学基于 boxx 使用一个端能力分以下几步：

1. 联系 boxx 的负责人， 在 boxx 内引入该端能力的兜底描述表， 完成后需要发布 boxx 的新版本(_已经引入的可跳过_)
2. 更新业务引用的 boxx 版本(_已经引入的可跳过_)
3. 在业务代码中调用， 此时有两种调用方式

```javascript
// 以 getNetworkType 端能力为例说明:

// 调用方式一: 适用于端能力不存在（端外或低版本端内）时需要有明确的兜底场景
if (boxx.canIUse('device.getNetworkType')) {
    // 必须先调用 canIUse 判断端能力是否存在，
    // 否则 boxx.device 及 boxx.device.getNetworkType 可能为空， 导致 js 报错
    boxx.device.getNetworkType({
        success: function (res) {
            // doSomething
        },
        fail: function () {
            // doSomething
        },
    });
}
else {
    // 端能力不存在时业务的兜底逻辑
    // 如果端能力是跳转 NA 页面的场景， 这里请务必添加兜底跳转逻辑， 避免点击后代码走到此逻辑导致无法跳转
}

// 调用方式二: 适用于不需要兜底的场景，此方法会吞掉调用过程中的所有 js 报错：
// api 不存在、参数错误等等
boxx.call('device.getNetworkType', {
    success: function (res) {
        // doSomething
    },
    fail: function () {
        // doSomething
    },
});
```

### NA 同学

主要用来调试、自测端能力功能是否正常， 直接使用 ES 平台上的 **jssdk 联调** 功能即可。

## 如何贡献

```bash
npm i # 安装依赖
npm start # 同 npm run dev ， 开始开发
npm run build # 编译， 产出各个业务方直接使用的文件： sdk、兜底描述表等
npm test # 执行一次单元测试
npm run upload # @todo 请补充说明
npm run deploy # @todo 请补充说明
npm run doc # @todo 请补充说明

```

### 开发

```bash
npm start # 或 npm run dev
```

> @todo 补充开发文档

#### 本地开发

```bash
npm run dev
```

浏览器打开 http://localhost:8099/，页面引用了兜底描述表，可debug example/category 目录下端能力

#### 真机调试

##### 域名设置

因为端能力的调用涉及到鉴权，需要在百度域下才能正常访问，为了能够调试端能力调用

所以需要将本地的 localhost 改为 任意的百度的域名，建立映射关系：

1. terminal 输入 sudo vi /etc/hosts 回车
2. 输入电脑的密码
3. 增加 127.0.0.1 test.baidu.com
4. esc :wq

##### 代理设置

真机连上电脑***代理***，使用手百debug包打开: http://test.baidu.com:8099/
或者不配置代理，在模拟器上，使用手百打开: http://test.baidu.com:8099/

##### js-native描述表配置

可以使用debug包强制打开端描述表下发开关来调试端描述表

android: deubg => 基础功能 => 能力配置 => 强制使用端描述表
ios: debugMode => MENU => 业务调试 => 端能力 => 域名白名单

#### mock 调试

### 编译

项目基于 [rollup](https://rollupjs.org/) 打包， 使用 [buble](https://www.npmjs.com/package/buble) 来做 ES6 -> ES 5 代码转换。

> @todo 后续考虑换成  babel 或直接迁移 ts

```bash
npm run build
```

编译产出：

- dist 目录：用于 npm 发布的四种文件
  - boxx.umd.js ： 默认文件，支持 umd 方式引用（包括 commonJS、AMD、全局变量 boxx）
  - boox.cjs.js ： 支持 commonJS 方式引用
  - boxx.min.js ： 即压缩后的 boxx.umd.js
  - boxx.esm.js ： 支持 ES Module 的方式引用

- cdn 目录：cdn 上传2个文件，均为压缩文件，支持 umd 方式引入。
  - boxx.min.js: 始终对应最新发布的文件
  - /boxx@1.2.1/boxx.min.js: 固定版本号
  - boxx@na-debug.min.js: 用于 NA 自测的版本（不压缩、禁用了前端预置描述表），因为客户端 RD 测试需要避免前端预置描述表而不能发现客户端缺失的描述表。

### 测试

#### 单元测试

项目基于 [jest](https://jestjs.io/) 进行测试， 使用 [babel-jest](https://www.npmjs.com/package/babel-jest) 来做 ES6 -> ES 5 代码转换。

已接入[流水线自动执行单元测试](https://console.cloud.baidu-int.com/devops/ipipe/workspaces/180189/pipelines/569837/builds/list?branchName=master)。

```bash
npm test # 执行一次单元测试， 此命令下， 如果缺少快照文件， 不会自动生成， 而是直接报错， 主要用于流水线上运行
npm run test:dev # 开发阶段以 watch 模式执行单元测试， 方便开发、调试， 此命令下， 如果缺少快照文件， 默认会自动生成
npm run test:update-snapshot # 执行一次单元测试， 并以此次执行结果为准来更新所有快照信息

```

### 发布

#### 发包

已接入[流水线自动发包机制](https://console.cloud.baidu-int.com/devops/icode/repos/baidu/ps-se-fe-tools/sfe-publish/tree/master)， 请在流水线操作发包：

- [发测试包](https://console.cloud.baidu-int.com/devops/ipipe/workspaces/180189/pipelines/569837/builds/list?branchName=master): cr 发出后， 可自行发测试包进行自测， 自测通过后再找代码库负责人过 cr
- [发正式包](https://console.cloud.baidu-int.com/devops/ipipe/workspaces/180189/pipelines/569835/builds/list?branchName=master): cr 合入后， 可自行发布正式包

#### 上传 CDN

> @todo 包括上传 es 平台等

### 添加兜底描述表

目前业务使用 boxx 调用端能力还需要兜底描述表来兼容低版本， 添加兜底描述表的步骤如下：

- 确保端上自 12.16 版本开始已经注入了对应的端能力描述表， 如果没有注入或注入的不对， 则需要：
  - 联系端能力对应的端研发同学进行注入修复， 随最近的一个版本上线
  - 待注入修复后， 提供描述表给 @邵颖蕙 来进行云控修复
- `./src/descriptions` 目录下对应的文件里新增端能力的描述表， 如果没有对应文件需新建， 以端能力的一级名称作为文件名
- 添加对应的在线示例、文档 @todo
- 跑一遍单元测试， 会自动生成基于该描述表的调起 schema 或数据， 并保存到 `./test/__snapshots__/unit/descriptions` 下， 生成的内容需要一起提交， 作为后续检查的基准， 具体逻辑可以参考 [./test/unit/descriptions/descriptions.js](./test/unit/descriptions/descriptions.js)
- 提交代码、发起 cr、合入

## 开发者文档

> @todo 待迁移

### 内置事件

```javascript
boxx.on(eventName, function (eventData) {
    // 自定义处理， 比如错误上报之类的
});
```

#### 常规事件

- 开始调用一个端能力时触发
  - eventName: `invoke:start`
  - eventData:
    - api: 端能力名称
    - args: 调用参数

#### 错误事件

错误事件的 eventData 里有一些通用字段， 这里统一说明：

- name: 错误名称
- api: 端能力名称
- message: 错误信息
- stack: 错误堆栈信息

内置的错误事件如下：

- 端能力 API 不存在
  - eventName: `error:api-missed`
  - eventData:
    - name: 值固定为 `"APIMissedError"`

- 端能力调用参数类型错误
  - eventName: `error:arg-invalid`
  - eventData:
    - name: 值固定为 `ArgInvalidError`
    - args: 类型错误的参数名称

- 端能力 schema 太长
  - eventName: `error:url-too-long`
  - eventData:
    - name: 值固定为 `URLTooLong`
    - length: schema 长度
    - url: 最终的 schema


- 端能力 schema 里存在预期外的关键字： null, undefined, NaN
  - eventName: `error:url-include-unexpected-keyword`
  - eventData:
    - name: 值固定为 `URLError`
    - keyword: 预期外的关键字
    - url: 最终的 schema

--------

> 以下为旧版说明， 重复内容优先以上文为准。

## 开发和构建部署命令

项目基于 rollup 打包，npm run dev 后会监听 src/index 及其依赖文件的文件改动；
会监听 example/index 及其依赖文件的改动，并自动刷新页面

安装 yarn

安装 fis3

安装依赖
```
npm i
```

## 开发
### 普通模式监听代码改动
```
yarn dev
```
浏览器打开 http://localhost:8099/ 即可

### 真机调试
有较多端能力涉及到鉴权，需要在百度的域名下才能访问，为了本地开发方便

所以需要将本地的 localhost 改为 任意的百度的域名，建立映射关系：

1. terminal 输入 sudo vi /etc/hosts 回车
2. 输入电脑的密码
3. 增加 127.0.0.1 test.baidu.com
4. esc :wq

使用模拟器的手百打开：  http://test.baidu.com:8099/
或者使用真机连上电脑的代理后，使用手百打开： http://test.baidu.com:8099/

### 描述表自测
比对描述表，通过 getDescription.js 中的打印语句 console.log(JSON.stringify(xxx)) 打印出 端上的描述表集合。
并保存在 descriptions/android-na.js 和 descriptions/ios-na.js 中。
然后打开 localhost:8099/diff.html 的控制台，即可查看本地预置描述表 和 端上 NA 的描述表的 对比结果。

### mock 调试
以 mock 的方式启动 example（即会使用 mock 文件夹的 description 以及方法），可以串联整个端能力的调起及响应。
```
yarn dev:mock
```

## 构建
### 线上版本构建（预置描述表、压缩）
```
yarn build
```

构建后会出现以下文件

- dist目录：用于 npm 发布的四种文件
    * boxx.umd.js ： 默认文件，支持 umd 方式引用（包括 commonJS、AMD、全局变量 boxx）
    * boox.cjs.js ： 支持 commonJS 方式引用
    * boxx.min.js ： 即压缩后的 boxx.umd.js
    * boxx.esm.js ： 支持 ES Module 的方式引用
    * boxx.devtools.js ：支持远程调试工具 [devtools-pro](https://github.com/ksky521/devtools-pro) 的端能力调试插件 [boxx-monitor](https://console.cloud.baidu-int.com/devops/icode/repos/baidu/hulk/boxx-monitor/tree/master)，支持 umd 方式引用

- cdn 目录：cdn 上传2个文件，均为压缩文件，支持 umd 方式引入。
    * boxx.min.js: 始终对应最新发布的文件
    * /boxx@1.2.1/boxx.min.js: 固定版本号
    * boxx@na-debug.min.js: 用于 NA 自测的版本（不压缩、禁用了前端预置描述表），因为客户端 RD 测试需要避免前端预置描述表而不能发现客户端缺失的描述表。

## 部署

### 部署线上压缩版本
```
yarn deploy
```
部署到开发机后的 demo 地址（区别于下述的地址）：http://yq01-zhoudan03.epc.baidu.com:8077/example/


### 部署用于 QA 测试的 demo
```
yarn deploy:test
```
部署到开发机后的 demo 地址（区别于上述的地址）：http://yq01-zhoudan03.epc.baidu.com:8008/example/index.html


### 部署文档
```
yarn deploy:doc
```
部署到开发机后的 文档 地址: http://yq01-zhoudan03.epc.baidu.com:8007/

## 上传 cdn

上传 cdn 文件时，需要在命令中指定 bos 对应的 sk，如果上传的需要，请联系 zhoudan03 提供 sk

### 上传线上版本到 cdn
```
BOS_SK=<sk> yarn upload
```
会上传以下三个文件

* boxx.min.js: 始终对应最新发布的文件
* /boxx@1.2.1/boxx.min.js: 固定版本号
* boxx@na-debug.min.js: 用于 NA 自测的版本（不压缩、禁用了前端预置描述表），因为客户端 RD 测试需要避免前端预置描述表而不能发现客户端缺失的描述表。

## 发布 npm 包
发布前提是已经注册登录了百度源。参见 http://fe.baidu-int.com/npm/usage

```
yarn release
```

发布新包时，需要更新 package.json 的版本号


## 上线
```
BOS_SK=<sk> yarn release
```

- 发布代码到 npm
- 部署压缩代码到 cdn
- 发布文档到开发机 / 线上 （待定）

npm 发布四种文件
* boxx.umd.js ： 默认文件，支持 umd 方式引用（包括 commonJS、AMD、全局变量 boxx）
* boox.cjs.js ： 支持 commonJS 方式引用
* boxx.min.js ： 即压缩后的 boxx.umd.js
* boxx.esm.js ： 支持 ES Module 的方式引用

cdn 上传2个文件，均为压缩文件，支持 umd 方式引入。
* boxx.min.js: 始终对应最新发布的文件
* /boxx@1.2.1/boxx.min.js: 固定版本号


## 语法规范
- 本项目是一个运行在手百浏览器的前端基础库，需要考虑兼容性，因此语法应该采用 ES5 语法；
- 本项目是一个和客户端进行通信的端能力通信库，有较高的性能要求，因此编码需要考虑性能影响；
    - 减少遍历，及时终止遍历
    - 使用 for 循环
- 项目使用了 rollup-plugin-buble，可以对一些简单的 ES6语法进行编译打包。支持和不支持的语法特性详见[buble文档](https://buble.surge.sh/guide/#supported-features) 简单来说包括以下几种
    - let / const
    - Class
    - 箭头函数（函数内未使用 this）
    - 方法属性
    - 模板字符串
    - 变量的解构赋值
    - 默认参数
    - 块级作用域
    - 指数运算符 **
    - 二进制和八进制数字
    - 计算属性


   不要使用对象扩展符（因为扩展运算符会转换为Object.assign()，仍然不被支持，除非使用 polyfill。

- 项目使用了 es6 module 进行模块依赖。

关于 rollup

对于判断语句，使用常量判断可以让 rollup 打包时去除无用代码，减少代码体积。

## 端能力
对于同一个端能力，ios 是用的协议，安卓需要用 command 才能调起。
需要由 boxx 来封装 intent 值，减少业务方的调用成本。


## 开发者文档

全局安装 gitbook 命令
```
npm i gitbook-cli -g
```

本地起服务，实时查看文档
```
yarn doc
```

访问 http://localhost:4000 查看文档

部署开发者文档
```
yarn deploy:doc
```
访问：http://atom.baidu-int.com:8080/ 查看开发机上的开发者文档

### 开发者文档规范
1. 一个分类一个 md 文件; 目录结构原则上按照字母排序
2. 中英文数字混排，英文/数字前后需要空格
3. 每个 API 文档包括以下内容
```
# 分类名

## API 名称

API 功能介绍

### 基本信息说明

- 版本支持

表格

提示：如需保证方法在任何版本上使用都不报错，需要在调用前判断

- 框架支持

表格

- es 平台端能力接口文档
[https://xxx](https://xxx)

如果双端不统一，则分开填写
Android： [https://xxx](https://xxx)
iOS： [https://xxx](https://xxx)

如果由于端能力被废弃，es 平台不存在，则附以前的 wiki / invoker 链接

### 入参说明

表头必须统一包含以下五列；表格的单元格对齐、数量一致，保证 md 文件本身的可阅读性

|  属性  |  类型  |  必填  |  默认值  |  描述  |
|--------|-------|--------|---------|-------|
|   key  |string |   否   |  'hello' |  标题 |

key 有效值
|   值    | 说明      |
| --------| -------- |
| 'hello' |  A 类型的 |
| 'hello' |  A 类型的 |

### 返回值说明

- 成功回调返回值：【强制】
    - 属性 （包括返回值的所有属性介绍。如果属性是个 Object，单起一个表格介绍每个属性）
        - status
        - message
        - 对于具体的返回数据，需要举例说明，值的格式（参见 ABTest.getSidList）
    - 类型
    - 描述
- 失败回调返回值：【可选】（如果无特殊错误码，提示链接，见详细错误码）
    - 属性
    - 类型
    - 描述


### 代码示例

代码片段需要注明 javascript，以应用 javascript 语言的高亮，增加文档的可阅读性。

```

- 参数值类型规范
    值支持的类型定义有下面几种,注意，普通属性小写 引用类型大写
    - boolean
    - string
    - number
    - function
    - Object
    - Array ：对于明确数组内元素类型的，补充 Array 类型。如 Array.<string> 或 Array.<number>

如果参数有有效值约束，可以单独拉表格 描述


开发语法，见 vuepress 官方指南


## 遗留问题
代码中有很多 todo 项目，在写 todo 时请标注 P 级别，以便分阶段 check 待办项目

P0 影响功能的 todo，在联调前解决
P1 上线依赖的内容，在上线前解决
P2 需要优化的点，有空随时优化

## 描述表规范
[TODO]


## 获取矩阵产品的端能力适配信息
```javascript
import ADAPTVERSION from '../adaptInfo/adaptversion';
```
1. ADAPTVERSION 从 adaptversion.json获取
2. 更改矩阵产品版本信息
    - 可以手动更改版本信息，但要同时同步adaptversion.json 和 adaptversion.js，
    - 也可以npm run updateAdapteInfo 从接口获取
3. 运行 npm run updateAdapteInfo，然后获取数据存入adaptversion.json 和 adaptversion.js
4. 写入完之后adaptversion.json 和 adaptversion.js 格式化可通过https://tool.oschina.net/codeformat/js
5. adaptversion.js 要加上eslint校验单引号的规则，要不然git提交报错 /* eslint quote-props: [1, "always"] */