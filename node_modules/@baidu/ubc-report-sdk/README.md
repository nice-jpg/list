# UBC Web SDK 使用文档
仅适用于@baidu/ubc-report-sdk@2.x
[TOC]

## SDK说明

为了使百度内、外部团队都可以更方便、高效、规范地使用UBC来进行web数据统计，我们发布基于UBC 2.0规范的WEB SDK。

## 1、集成SDK

集成代码的方式有两种，最简单的方式是通过接入平台，直接获取接入代码。但是为了便于构建，也可以通过npm来引入。


### 1.1 直接引用

```
<!-- UBC WEB SDK code version 2.0.8 -->
<script type='text/javascript'>
(function(i, s, o, g, r, a, m) {
    i['UBCReportObject'] = r;
    i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments);
    }
    i[r].l = 1 * new Date();

    a = s.createElement(o);
    m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m);
})(
    window,
    document,
    'script',
    'https://efe-h2.cdn.bcebos.com/cliresource/ubc-report-sdk/2.1.2/ubc-web-sdk.umd.min.js',
    'ubc'
);

</script>
```

请将以上代码放置到需要分析的页面中的 `<head>` 和 `</head>` 标签之间，即可完成 Web JS SDK页面代码的安装。


> Web JS SDK 通过异步方式引入，不会影响页面的加载速度。脚本为下载并执行时，调用`ubc()`方法进行的统计上报都会将参数记录在` window.ubc.q`中。在统计脚本下载完毕后，再进行上报。

### 1.2 npm安装包

npm加载仅适用于百度内网用户。可以使用如下命令安装：

```
npm install @baidu/ubc-report-sdk --registry=http://registry.npm.baidu.com
```

在业务代码中引入

```
import ubc from '@baidu/ubc-report-sdk';
// 或者
const ubc = require('@baidu/ubc-report-sdk/ubc-web-sdk.umd.min.js');
```

> **注意：**  需要使用百度源，通过npm安装包安装后，


## 2、SDK的API

### 1.1 Web JS SDK API 简介

目前统计上报SDK的API比较简答，后续随着统计维度和功能的增加会逐步完善。

----------

**ubc(category, ...)**

----------

通过SDK引入后，会在全局声明一个`ubc`方法。该方法的第一个参数**必须**传入一个指令。

```

ubc(category, [后续参数根据 category 来确定]);


```

现在的`category`共包含:

|category			|说明		|
|---------------|-----------|
|init			|进行SDK初始化  |
|config			|更改SDK全局配置或者全局参数|
|pv				|进行页面PV上报|
|event			|进行事件上报|
|timing			|进行时长上报|

### 1.2 Web JS SDK 初始化

----------

**ubc('init',  server_id ,  configs)**

----------


|字段		|默认值	|必填	|类型		|描述				|
|-----------|-------|-------|-----------|-------------------|
|serverId	|		|是		|number		|一个活动或者项目的事件ID|
|configs	|		|否		|Object		|公参及SDK功能配置信息		|

SDK初始化时，需要传入一些业务相关的参数。根据目前的规范，一些与业务相关的固定参数，都已经内置到SDK内部。目前在初始化时，需要将页面的公共参数和SDK配置参数一起传入。包含活动ID（`serverId`），时长统计ID，页面标识等。
```
@paran {number} serverId 项目ID，活动唯一标识
@paran {Object} configs 项目配置项，建议在初始化时，指定所有公共参数和设置参数
ubc('init', serverId, configs);

// example
ubc('init', your serverId, {
    version: '2.0',
	timingId: your timingId,
	page: 'home'
});
```


configs参数包含对SDK的功能配置参数以及一些可以全局配置的参数。

**configs字段详解**

|字段			|版本说明   |说明					|默认值		|示例			|
|---------------|---------|-----------------------|-----------|---------------|
|testMode		|v1 v2    |测试模式，打点到测试平台	  |false		|true、false	|
|page			|v1 v2    |页面标识,[请参考命名规范](http://agroup.baidu.com/bi_frontend/md/article/1186680#1%E6%8E%A5%E5%85%A5%E8%A7%84%E8%8C%83)	|不带参数的页面URL地址|www.baidu.com|
|source			|v1 v2    |渠道来源				   |url中的idfrom|baiduSearch、shoubaipush|
|timingId		|v1 v2    |项目时长标识,需要申请（如果没有单独的时长ID，可以填serverId）。	 |-			|10001			|
|from			|v1 v2    |业务标识 			   |act		|默认为act（运营活动）,可以自定义		|
|network		|v1       |网络状态,依赖端能力		 |-			|wifi、nowifi、 3G|
|baiduTongJiId	|v1 v2    |百度统计的服务ID，可选	  |			|86aa06a9dcc769d2ddedacee06ec32cc|
|autoPvTrack	|v1 v2    |是否启用自动pv统计，可选   |false		|true、false		|
|autoTimingTrack|v1 v2    |是否启用自动页面时长统计.启用后,会在init到离开页面期间一直发送时长请求。	   |false		|true、false		|
|abtest         |v1       |AB试验号                |''          |单个实验号:123;多个试验号:123_124_125|
|queryParams    |v2       |顶级参数，内部值会同步到url一级参数中，默认为不传|不传|  `{from: 'xxxx-from',cfrom: 'xxxx-cfrom',appname: 'baiduboxapp',smfw: 'smfw-xxxx}`|
|queryParams.from|v2      |来源                   |不传     |xxxx                         |
|queryParams.cfrom|v2     |子来源                 |不传     |xxxx                          |
|queryParams.appname|v2   |产品线                 |baiduboxapp     |baiduboxapp                    |
|queryParams.smfw |v2    |实验号标识，String 或 Map |不传     |xxxx                           |
|version            |v2    | `UBC规范的版本号:2.0`，v2必须传，String  |不传     |2.0                          |
|ifHeartbeatTime  |v2    |时长打点是否使用心跳包，在不使用心跳包的情况下，建议使用者手动停止时长打点（2.2.0及以后版本可用）  |true     |                        |

> 关于`version`的特别说明：`version`不传，默认为`1.0`，此时只能使用v1的字段，上报会发送到`/tcbox?action=pblog`，。申明`version: '2.0'`后，此时才能使用v2的参数，上报将发送到`/ztbox?action=zpblog`

### 1.3 Web JS SDK 公共参数和SDK设置参数

configs参数包含对SDK的功能配置参数以及一些可以全局配置的参数。所有公共参数**建议**都在初始化时指定。如果需要临时更改（一般很少出现这种情况），可是使用`config`命令来修改。

```
@param {Object} configs SDK配置
ubc('config', configs);
```

> 一般不建议使用`config`命令来进行更改。使用`config`命令对公参和配置进行更改时，也仅能更改部分字段。如`network`、`page`、`source`、`from`、`testMode`等字段。剩余字段不允许更改。

**自动功能配置**

SDK的功能配置中包含是否开启默认页面PV`autoPvTrack`以及时长统计`autoTimingTrack`。
SDK初始化之后，会自动执行页面PV上报和页面时长统计上报。

自动上报的PV，页面时长统计的字段中`type`字段分别为`pageAutoPv`和`pageAutoTiming`。其余字段都取公共字段。

如需关闭默认统计，可以通过如下方式：

```
ubc('init', '1000', {
    version: '2.0',
	autoPvTrack: false,
	autoTimingTrack: false
});
```

**日志校验模式**

> 开发和测试时建议开启

可以通过设置`testMode: true, version: '2.0'`来开启测试模式，统计数据会上报的线下，访问[日志校验平台](http://feedlog.amis.baidu.com/ubc/manucheck)可以查看数据上报详情以及埋点参数是否正确。
ps: 只有`version`为2.0才能在线下进行校验

> 上线时请注意更改为 `testMode: false`。


**集成百度统计**

SDK可以集成百度统计，设置`baiduTongJiId: [统计服务的标识]`后，所有事件的上报会同时上报到百度统计中。如果不设置`baiduTongJiId`，将不会进行百度统计上报。

> 统计服务的标识需要登录到百度统计平台上，添加项目后获得。


**全局配置参数**

全局配置参数中维护了一个页面的公共字段，包含页面标示`page`（该字段将用于进行自动PV、时长的统计，如果具体的时间中未指page字段，默认会使用这个值）、资源位信息 `source`、 业务来源标识`from` 、网络信息`network`等。

```
// example
ubc('init', '1000', {
    version: '2.0',
	page: 'home',
	source: 'shoubaikaiping0831',
	network: 'wifi'
});
```

configs字段详解

|字段			|说明					|默认值		|示例			|
|---------------|-----------------------|-----------|---------------|
|testMode		|测试模式，打点到测试平台	|false		|true \| false	|
|page			|页面标识				|不带参数的页面URL地址|www.baidu.com|
|source			|渠道来源				|url中的idfrom|baiduSearch \|shoubaipush|
|timiingId		|项目时长标识,需要申请		|-			|10001			|
|from			|业务标识				|act		|固定为act		|
|network		|网络状态,依赖端能力		|-			|wifi \| nowifi \| 3G|
|autoPvTrack	|是否启用自动pv统计		|true		|true \| false		|
|autoTimingTrack|是否启用自动页面时长统计	|true		|true \| false		|
|duration       |时长打点间隔             | 3         |   0.5\|5       |

> 关于网络状态，目前该字段在数据分析计算时并没有使用，所以可以暂时不上报。如果要上报，网络状态的获取，通常是一个异步方法，但在获取网络成功后再上报会影响数据的准确性。所以建议仅获取一次即可，且不要求实时性。

### 1.4 Web JS SDK PV统计

PV上报主要是针对页面进行PV，UV的统计。

```
@param {string} pageName 页面标示
ubc('pv', pageName);
```
**自动PV上报**

SDK会自动上报页面的PV。其中page值取值为不带参数的页面URL地址。如地址为`http://www.baidu.com/?q=xiaoming`， page标识会取值为`www.baidu.com`。等同于

```
ubc('pv', 'www.baidu.com');
```

**自定义PV上报**

如果需要对页面按照特定的标识来进行PV统计，也可以使用自定义PV上报。
```
ubc('pv', 'pageName');
```

### 1.5 Web JS SDK 事件统计

事件上报主要针对用户的行为如点击事件进行统计。

----------

**ubc('event', options[, callback])**

----------


|字段		|默认值	|必填	|类型		|描述				|
|-----------|-------|-------|-----------|-------------------|
|options	|		|是		|string		|事件描述信息			|
|callback	|		|否		|Object		|上报成功后的回调函数	|

事件上报是UBC统计中最重要的方法。通常用来统计用户在特定元素上发生的交互行为：如弹框的展现，按钮的点击；也会用来统计用户触发的一些事件，比如登录成功、分享成功等。

```
@param {string} eventName 事件名称
@param {Obeject} options 事件描述配置对象
@paran {Function} callback  上报成功的回调
ubc('event', eventName | options [,callback]);
```

**options详解**

```
@param {string} options.page 页面标识，默认取公共字段中的page
@param {string} options.type 事件名称
@param {string} options.value 场景信息，如事件发生时的特定场景
@param {string} options.ext.p1 事件属性一
@param {string} options.ext.p2 事件属性二
@param {string} options.ext.p3 事件属性三
@param {number} useSendBeacon 事件属性三
```

|字段			|说明					|是否必须|默认值		|示例			|
|---------------|-----------------------|-------|-----------|---------------|
|page			|页面标识,[请参考命名规范](http://agroup.baidu.com/bi_frontend/md/article/1186680#1%E6%8E%A5%E5%85%A5%E8%A7%84%E8%8C%83)	|否		|默认取公共字段中的page|www.baidu.com|
|type			|事件名称				|是		|			|loginBtn		|
|value			|场景信息，如事件发生时的特定场景|否	|空			|newUser \|	oldUser	|
|ext.p1			|事件属性一，如事件对象的信息|否		|空			|分享按钮的信息 weibo \| qq \| weixin|
|ext.p2			|事件属性二，如事件的状态	|否		|空			|success \| failed |
|ext.p3			|事件属性三，如事件对象的不同版本|否 	|空			|A \| B				|
|useSendBeacon	|使用SendBeacon发送请求(0继承全局配置，1开启，2关闭) |否 	|0			|0 \| 1	\| 2|

**示例**

```
// example
ubc('event', {
	page: 'login_dialog',
	type: 'shareBtnClick',
	value: 'newUser',
	ext: {
		p1: 'weixin',
		p2: 'success'
	},
    useSendBeacon: 1
});
```


关于事件名称，之前类似于登录框展现次数`loginDilog_pv`,  登录成功次数`shareSucc_clk`之类的命名容易让人误解，建议采用`loginDilogShow`, `shareSucc`来替换。因为pv是`page view`的简写，而`clk`是点击的简写，不符合事件的本意。

> 对于事件的统计，需要注意。一旦使用了value、extP1、extP2、extP3这些非必须字段，会**大大增加**研发同学的成本，从而会增加出错的几率，在提需时要注意尽量**克制使用**。

**关于回调事件**

事件上报可以传入第三个参数，必须是一个函数。在完成事件上报后，会执行回调函数。比较常用的场景是点击按钮后进行上报，上报成功后进行跳转。

```
ubc('event', {
	type: 'shareBtnClick',
	value: 'newUser',
	ext: {
		p1: 'weixin',
		p2: 'success'
	}
}，function() {
	window.location.href = 'www.baidu.com';
});
```

这样处理的主要原因是，当一个事件触发了页面跳转或者页面刷新时，此时发出的上报请求有一定的概率会因为页面重载而上报失败。具体请参考[页面跳转和刷新造成的前端丢点问题](http://agroup.baidu.com/bi_frontend/md/article/1186202#1%E9%A1%B5%E9%9D%A2%E8%B7%B3%E8%BD%AC%E5%92%8C%E5%88%B7%E6%96%B0%E9%80%A0%E6%88%90%E7%9A%84%E5%89%8D%E7%AB%AF%E4%B8%A2%E7%82%B9%E9%97%AE%E9%A2%98)

> 这里所说的**上报成功后的回调**，其实并不总是在上报成功后才会回调，如果上报请求超出一定的时间后还未成功响应，则也会执行回调事件。目前SDK对该值的设置为`100ms`。

### 1.6 Web JS SDK 时长统计

> 如果要进行时长上报，需要在config字段中申明项目所申请的`timingId`。

时长统计除了用于页面的停留时长外，还可用于对视频观看时长等持续进行的**状态**的时间进行统计。对于一个持续进行的状态，需要在**状态**开始和结束时分别调用两次方法，`ubc('timing', 'start', eventName);`执行后，SDK内部会每隔3秒上报一次统计，`ubc('timing', 'end', eventName)`执行后，SDK内部会停止时间的上报。

时长上报间隔可以在init的时候进行设置

如果需要使用日志平台的时长rdc转发，需要升级到2.2.0以上版本，且设置`ifHeartbeatTime`为false

```
ubc('init', '1000', {
    timingId: '123', // timingId
	duration: 5
});
```
#### v2.1.6之前支持以下的timing写法
```
@param {string} status 起始还是终止， start | end
@param {string} eventName 事件名称
@param {Object} value 事件描述信息
@param {Object} ext   额外信息 v2.0.7及以后版本支持

ubc('timing', status, eventName[, value, ext]);
```


|字段		 |默认值	|必填	|类型		|描述				|
|-----------|-------|-------|-----------|---------------|
|status		|		|是		|string		|事件的开始或者结束	|
|eventName	|		|是		|string		|事件标识符	|
|value      |       |否     |string     |事件描述信息|
|ext        |       |否     |object     |额外信息 v2.0.7及以后版本支持|

#### @baidu/ubc-report-sdk@2.1.6及以后支持以下的timing写法（推荐）
```
@param {string} status 起始还是终止， start | end
@param {string} eventName 事件名称
@param {Object} options 事件描述配置对象
@param {Object} options.type  事件标识符，默认取eventName的值
@param {Object} options.value 事件描述信息
@param {Object} options.ext   额外信息

ubc('timing', status, eventName[, options]);
```

如果在结束打点的时候传递`options`值，会覆盖最后时长一次打点的参数值。

**示例**
```
// 时长统计起始时间发送
ubc('timing', 'start', eventName, {
    type: 'click',
    value: 'home',
    ext: {
        p1: 1,
        p2: 2
    }
});

// 时长统计结束时间发送
ubc('timing', 'end', eventName);

// 时长统计结束时间发送(带options)
ubc('timing', 'end', eventName, {
    value: 'toSubPage',
});
```


> 如果要进行时长上报，需要在config字段中申明项目所申请的`timingId`。

时长统计除了用于页面的停留时长外，还可用于对视频观看时长等持续进行的**状态**的时间进行统计。对于一个持续进行的状态，需要在**状态**开始和结束时分别调用两次方法，`ubc('timing', 'start', eventName);`执行后，SDK内部会每隔3秒上报一次统计，`ubc('timing', 'end', eventName)`执行后，SDK内部会停止时间的上报。

### 1.7 多实例使用方法


> 在特殊情况下，一个项目甚至一个页面中，可能会使用多个serverId。这个时候就需要创建多个跟踪器实例。

如下方式可以在同一个页面中声明两个跟踪器实例。
```
// 进行初始化
ubc('init', '1000', {
    timingId: '1001',
    testMode: true,
    page: 'home',
    from: 'act',
    network: 'wifi',
    autoPvTrack: true,
    autoTimingTrack: true
});

// 进行第二个跟踪器的初始化
ubc('secondTracker.init', '10005', {
    timingId: '100101',
    testMode: true,
    page: 'home',
    from: 'act',
    network: 'wifi',
    autoPvTrack: true,
    autoTimingTrack: true
});
```

在后续的统计上报中，需要通过类似如下的方式进行上报：

```
ubc('secondTracker.event', ...);
```
