/**
 * @file babel配置
 * @author yangmei(yangmei03@baidu.com)
 */

module.exports = function (api) {
    api.cache(true);
    const presets = [];
    const plugins = [
        '@babel/plugin-proposal-optional-chaining',
        '@babel/plugin-proposal-async-generator-functions',
        '@babel/plugin-proposal-nullish-coalescing-operator',
        ['@babel/plugin-proposal-pipeline-operator', {proposal: 'smart'}]
    ];
    // apm特殊打包 amd模块和完备的polyfill
    if (process.env.NODE_ENV === 'build:apm') {
        presets.push([
            '@babel/preset-env',
            {
                useBuiltIns: 'usage',
                targets: {ie: 9},
                corejs: 3
            }
        ]);
    }
    // 单测需要转一下es modules至commonjs
    if (process.env.NODE_ENV === 'test:unit') {
        plugins.push('@babel/plugin-transform-modules-commonjs');
    }
    return {
        presets,
        plugins,
        exclude: [/core-js/]
    };
};