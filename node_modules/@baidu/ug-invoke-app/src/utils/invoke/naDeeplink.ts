/**
 * @file na deeplink能力
 * @author zhangsiyuan(zhangsiyuan@baidu.com)
 */

import {DeeplinkApp, deeplinkConfigMap} from '../../config/app/deeplinkConfigMap';
import {invokeAction} from './invokeAction';
import {Status} from '../../config/Status';
import {InvokeType} from '../../config/app/InvokeType';
import {handleInvokeFailed} from './handleInvokeFailed';
import {InnerInvokeConfig} from '../../api/invokeApp';
import {sendH5ErrLog} from '../log/errorLog';

export async function naDeeplink(options: InnerInvokeConfig, browser: DeeplinkApp): Promise<Status> {
    return new Promise(resolve => {
        console.warn('开始尝试deeplink调起！');
        const {getScheme, successCode} = deeplinkConfigMap[browser];

        // 回调是小程序触发的，类型很难搞啊
        function callback(result: string) {
            let res = JSON.parse(result);
            if (+res.status === successCode) {
                sendH5ErrLog(options, Status.INVOKE_SUCCESS);
                resolve(Status.INVOKE_SUCCESS);
            }
            else {
                console.warn('deeplink端能力返回错误: ', res);
                resolve(handleInvokeFailed(options, InvokeType.DEEPLINK));
            }
        }

        invokeAction(getScheme(options.scheme, callback), options.appName);
    });
}
