<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script>window.__perf_white_screen = performance.now();</script>
</head>
<body>
    <div style="width:100%;height: 667px;">
        <div>open devtool</div>

        <button onclick="gettiming()" style="width:300px;height: 50px;">点此更新performance timing</button>
        <pre id="text"></pre>
        <script>window.__perf_first_screen = performance.now();</script>

    </div>

    <script src="/dist/spy.js"></script>
<script type="text/javascript">
const spy = new Spy({
    pid: '1_1000', // 必须
    lid: '', // 可选，页面的logid
    sample: 1 // 全局抽样，取值：[0-1], 所有发送接口都受到该抽样，单个发送接口的sample配置会覆盖该抽样。
});

// 如果你还有一段代码执行耗时，那么
let startTime = Date.now();
document.body.style.border = '2px solid red';
document.body.getBoundingClientRect();
let layoutTime = Date.now() - startTime;

spy.sendPerf({
    // 可选, 分组，默认common，用户自定义
    group: 'test',
    // 必须, 指标信息，每个字段为一个指标，由用户自定义
    info: {
        whiteScreen: Math.round(window.__perf_white_screen), // 需要你自行计算好时间再发送，不能带单位
        fisrtScreen: Math.round(window.__perf_first_screen),
        layout: layoutTime
    },
    // 可选，维度信息，每个字段为一个维度，由用户自定义
    dim: {
        os: 'ios',
        netType: 'wifi'
    }
});

spy.sendExcept({
    // 可选, 分组，默认common，用户自定义
    group: 'test',
    // 必须, 异常信息，msg字段是必须的，是异常唯一标识。其他字段作为补充信息，由用户自定义
    info: {
        msg: 'fail to play video',
        module: 'videoDetaiPage'
    },
    // 可选，维度信息，每个字段为一个维度，由用户自定义
    dim: {
        os: 'ios',
        netType: 'wifi'
    }
});

spy.sendDist({
    // 可选, 分组，默认common，用户自定义
    group: 'test',
    // 必须, 指标信息，每个字段为一个指标，由用户自定义
    info: {
        isLogin: 'yes'
    },
    // 可选，维度信息，每个字段为一个维度，由用户自定义
    dim: {
        os: 'ios',
        netType: 'wifi'
    }
});

spy.sendCount({
    // 可选, 分组，默认common，用户自定义
    group: 'test',
    // 必须, 指标信息，每个字段为一个指标，由用户自定义
    info: {
        buttonClick: 1
    },
    // 可选，维度信息，每个字段为一个维度，由用户自定义
    dim: {
        os: 'ios',
        netType: 'wifi'
    }
});

try {
    throw new Error('test');
}
catch (e) {
    spy.sendExceptForError(e, {
        // 可选, 分组，默认common，用户自定义
        group: 'test',
        // 可选，这里的info只需要补充其他用户自定义信息，因为msg、stack等错误信息字段，接口会自动获取
        info: {
            from: 'baidu'
        },
        // 可选,维度信息
        dim: {
            os: 'ios',
            netType: 'wifi'
        }
    });
}

// 监听全局error并上报
spy.listenGlobalError({
    // 可选，默认common
    group: 'test',
    // 可选，这里的info只需要补充其他用户自定义信息，因为msg、stack等错误信息字段，接口会自动获取
    info: {
        path: '/s'
    },
    // 可选,维度信息，
    dim: {
        os: 'ios',
        netType: 'wifi'
    }
});

setTimeout(() => {
    let obj = {};
    obj.init();

    // 取消对全局error的监听上报
    spy.unListenGlobalError();
});

spy.getPerformanceTimingInfo(info => {
    spy.sendPerf({
        group: 'test',
        info: info,
        dim: {
            os: 'ios',
            netType: 'wifi'
        }
    });
});

const domain = location.protocol === 'http:'
    ? 'http://sestat.baidu.com/mwb2.gif?'
    : 'https://sp1.baidu.com/5b1ZeDe5KgQFm2e88IuM_a/mwb2.gif?';

// 构造url的query部分
const query = [
    'pid=1_1000', // 必须
    'lid=xxxx', // 可选，页面的logid
    'ts=' + Date.now(), // 必须，页面的logid
    'type=perf', // 必须，perf 说明是性能日志， except异常日志等
    'group=test', // 可选，group分组默认是common
    // 必须，性能指标采集
    'info=' + encodeURIComponent(
        JSON.stringify({
            fisrtScreen: 800, // 需要你自行计算好时间再发送，不能带单位
            whiteScreen: 500
        })
    ),
    // 可选，发送自己的维度
    'dim=' + encodeURIComponent(
        JSON.stringify({
            netType: 'wifi',
            pageType: 'car'
        })
    )
].join('&');

const url = domain + query;

// 目前服务器端支持sendBeacon的post请求，可以优先采用，该api可以降低打点丢失率
if (!(navigator.sendBeacon && navigator.sendBeacon(url))) {
    (new Image()).src = url;
}

spy.startMark('playTime');

// ... // 执行花费1s

let time = spy.endMark('playTime');
console.log(time); // output: 1000

spy.startMark('pauseTime');

// ... // 执行花费1s

spy.endMark('pauseTime');
console.log(spy.getAllMark());
// output
// {
//     playTime: 1000,
//     pauseTime: 1000
// }


function gettiming() {
    document.getElementById('text').innerHTML = JSON.stringify(performance.timing, null, 4);
}

window.onload = function () {
    setTimeout(() => {
        gettiming();
    }, 100);
};
</script>
</body>
</html>