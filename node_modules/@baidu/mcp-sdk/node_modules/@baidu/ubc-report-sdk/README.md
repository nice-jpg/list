# UBC WEB SDK
(此文档仅适用于@baidu/ubc-report-sdk@3.x)
基于UBC 2.0规范的web端埋点SDK

## 答疑群
百度hi群：2340151

## 旧版本

https://console.cloud.baidu-int.com/devops/icode/repos/baidu/jady/ubc-web-sdk/tree/master

## 使用方式

### npm安装（推荐）
npm加载仅适用于百度内网用户。可以使用如下命令安装：
```bash
npm install @baidu/ubc-report-sdk --registry=http://registry.npm.baidu.com
```

`@baidu/ubc-report-sdk`提供了`ubcLogger`,`UbcLogger`两个变量，前者为后者的默认实例。

在业务代码中引入
```js
import {ubcLogger,UbcLogger} from '@baidu/ubc-report-sdk';

ubcLogger.set({
    page:'example_page',
    serverId: '1234'
});

ubcLogger.send({
    value: 'c_pv'
});

const anotherUbcLogger = new UbcLogger({
    page:'example_page',
    serverId: '1235'
});

anotherUbcLogger.send({
    value: 'btn_clk'
});

```


### 使用sdk

```html
<script src="https://efe-h2.cdn.bcebos.com/cliresource/@baidu/ubc-report-sdk/3.3.3/ubc-report-sdk.iife.min.js"></script>
```
请将以上代码放置到需要分析的页面中的 <head> 和 </head> 标签之间，即可完成 Web JS SDK页面代码的安装。需要保证所有打点代码在脚本引入后进行打点
此时存在ubcLogger和UbcLogger两个全局挂载的变量
> 如果需要兼容低版本浏览器可以使用以下方式
```html
<script type="module" src="https://efe-h2.cdn.bcebos.com/cliresource/@baidu/ubc-report-sdk/3.3.3/ubc-report-sdk.iife.min.js"></script>
<script nomodule src="https://efe-h2.cdn.bcebos.com/cliresource/@baidu/ubc-report-sdk/3.3.3/ubc-report-sdk.iife.polyfill.min.js"></script>
```

> 或者只使用polyfill版本
```html
<script src="https://efe-h2.cdn.bcebos.com/cliresource/@baidu/ubc-report-sdk/3.3.3/ubc-report-sdk.iife.polyfill.min.js"></script>
```

## API Reference


<a name="UbcLogger"></a>

## UbcLogger
**Kind**: global class  

* [UbcLogger](#UbcLogger)
    * [new UbcLogger([options])](#new_UbcLogger_new)
    * [.set([options])](#UbcLogger+set)
    * [.send(params, [options])](#UbcLogger+send) ⇒ <code>Promise</code>
    * [.sendMergeLog(params)](#UbcLogger+sendMergeLog) ⇒ <code>Promise</code>
    * [.startTimingLog([label], [params], [options])](#UbcLogger+startTimingLog)
    * [.pauseTimingLog([label])](#UbcLogger+pauseTimingLog)
    * [.stopTimingLog([label])](#UbcLogger+stopTimingLog)
    * [.getVersion()](#UbcLogger+getVersion) ⇒ <code>string</code>

<a name="new_UbcLogger_new"></a>

### new UbcLogger([options])
Create a UbcLogger


| Param | Type | Default | Description |
| --- | --- | --- | --- |
| [options] | <code>Object</code> |  | 初始化入参 |
| [options.serverId] | <code>number</code> |  | 活动serverId |
| [options.page] | <code>string</code> |  | 页面page名称 |
| [options.type] | <code>string</code> |  | 打点type |
| [options.from] | <code>string</code> |  | 日志类型 |
| [options.queryParams] | <code>Object</code> |  | ubcUrl上的query(appname,from,cfrom,smfw) |
| [options.testMode] | <code>boolean</code> | <code>false</code> | true走线下地址; false或者为空走线上ubc地址，目前日志平台采用新校验方式，不需要走线下地址 |
| [options.testUrl] | <code>string</code> |  | 打点数据上传地址;传入后，打点数据将发送至该地址 |
| [options.source] | <code>string</code> |  | 资源位source |
| [options.idfrom] | <code>string</code> |  | 资源位idfrom(等价于资源位source，优先级更高) |
| [options.ifHeartbeatTime] | <code>boolean</code> | <code>true</code> | 时长打点是否为心跳点，默认为true |
| [options.useSendBeacon] | <code>boolean</code> | <code>false</code> | 使用SendBeacon API进行打点 |
| [options.logMergeOpt] | <code>Object</code> |  | 日志合并参数配置 |
| [options.logMergeOpt.ifAutoMerge] | <code>Object</code> |  | 是否开启自动合并，默认不开启 |
| [options.logMergeOpt.mergeNumMax] | <code>Object</code> |  | 最大日志合并数量 |
| [options.logMergeOpt.mergeInterval] | <code>Object</code> |  | 合并时间间隔 |
| [options.logErrRetry] | <code>boolean</code> |  | 是否开启日志重试 |
| [options.ext] | <code>Object</code> |  | 公共的ext参数，会被send的传参覆盖 |

<a name="UbcLogger+set"></a>

### ubcLogger.set([options])
set
options可不填，缺省字段会以上次设置的为准

**Kind**: instance method of [<code>UbcLogger</code>](#UbcLogger)  

| Param | Type | Description |
| --- | --- | --- |
| [options] | <code>Object</code> | 初始化入参 |
| [options.serverId] | <code>number</code> | 活动serverId |
| [options.page] | <code>string</code> | 页面page名称 |
| [options.from] | <code>string</code> | 日志类型 |
| [options.queryParams] | <code>Object</code> | ubcUrl上的query(appname,from,cfrom,smfw) |
| [options.testMode] | <code>string</code> | true走校验模式; false或者为空走线上ubc地址 |
| [options.testUrl] | <code>string</code> | 打点数据上传地址;传入后，打点数据将发送至该地址（需要testMode=true） |
| [options.source] | <code>string</code> | 资源位source |
| [options.idfrom] | <code>string</code> | 资源位idfrom(等价于资源位source，优先级更高) |
| [options.ifHeartbeatTime] | <code>boolean</code> | 时长打点是否为心跳点 |
| [options.useSendBeacon] | <code>boolean</code> | 使用SendBeacon API进行打点，默认false |
| [options.useXhr] | <code>boolean</code> | 使用xhr进行打点,默认false |
| [options.sendMethod] | <code>string</code> | 单条请求发送方式 get/post，默认get，配合useXhr使用 |
| [options.logMergeOpt] | <code>Object</code> | 日志合并参数配置 |
| [options.logMergeOpt.ifAutoMerge] | <code>boolean</code> | 是否开启自动合并，默认不开启 |
| [options.logMergeOpt.mergeNumMax] | <code>number</code> | 最大日志合并数量。默认5条 |
| [options.logMergeOpt.mergeInterval] | <code>number</code> | 合并时间间隔，默认5s,单位s |
| [options.logErrRetry] | <code>boolean</code> | 是否开启日志重试 |
| [options.ext] | <code>Object</code> | 公共的ext参数，会被send的传参覆盖 |

**Example**  
```js
ubclogger.set({
    serverId:123,
    idfrom:'res_fuli',
    page:'index'
})
```
<a name="UbcLogger+send"></a>

### ubcLogger.send(params, [options]) ⇒ <code>Promise</code>
send

**Kind**: instance method of [<code>UbcLogger</code>](#UbcLogger)  
**Returns**: <code>Promise</code> - promise 打点成功发送返回then  

| Param | Type | Description |
| --- | --- | --- |
| params | <code>Object</code> | 打点自定义参数 |
| [options] | <code>Object</code> | 额外选项 |
| [options.useSendBeacon] | <code>boolean</code> | 是否使用SendBeacon API发送请求 |
| [options.useXhr] | <code>boolean</code> | 是否使用Xhr发送请求 |
| [options.sendMethod] | <code>string</code> | 单条请求发送方式 get/post，默认get，配合useXhr使用 |

**Example**  
```js
ubclogger.send({
    page: 'y_ent_login',
    type: 'login_clk',
    value: 'login',
    ext: {
        p1: 'login'
    }
})
```
<a name="UbcLogger+sendMergeLog"></a>

### ubcLogger.sendMergeLog(params) ⇒ <code>Promise</code>
sendMergeLog

**Kind**: instance method of [<code>UbcLogger</code>](#UbcLogger)  
**Returns**: <code>Promise</code> - promise 打点成功发送返回then  

| Param | Type | Description |
| --- | --- | --- |
| params | <code>Object</code> | 打点自定义参数 |

**Example**  
```js
ubclogger.sendMergeLog({
    page: 'y_ent_login',
    type: 'login_clk',
    value: 'login',
    ext: {
        p1: 'login'
    }
})
```
<a name="UbcLogger+startTimingLog"></a>

### ubcLogger.startTimingLog([label], [params], [options])
startTimingLog 开始

**Kind**: instance method of [<code>UbcLogger</code>](#UbcLogger)  

| Param | Type | Default | Description |
| --- | --- | --- | --- |
| [label] | <code>\*</code> | <code>default</code> | 时长打点必须拥有唯一的名字，默认default |
| [params] | <code>Object</code> |  | 打点自定义参数 |
| [options] | <code>Object</code> |  | 打点设置，覆盖全局设置 |
| [options.ifHeartbeatTime] | <code>boolean</code> |  | 是否通过心跳打点 |
| [options.useSendBeacon] | <code>boolean</code> |  | 是否使用 SendBeacon API |
| [options.duration] | <code>number</code> |  | 心跳打点的间隔，单位s |

**Example**  
```js
ubclogger.startTimingLog('timing1',{
    page: 'y_ent_login',
    type: 'login_clk',
    value: 'login',
    ext: {
        p1: 'login'
    }
})
```
**Example**  
```js
ubclogger.startTimingLog('timing1',{
    page: 'y_ent_login',
},{
    useSendBeacon: true
}
```
<a name="UbcLogger+pauseTimingLog"></a>

### ubcLogger.pauseTimingLog([label])
pauseTimingLog 停止打点,保留该时长点的参数,可被重新启动

**Kind**: instance method of [<code>UbcLogger</code>](#UbcLogger)  

| Param | Type | Default | Description |
| --- | --- | --- | --- |
| [label] | <code>\*</code> | <code>default</code> | 时长打点必须拥有唯一的名字，默认default |

**Example**  
```js
ubclogger.pauseTimingLog('timing1');
```
<a name="UbcLogger+stopTimingLog"></a>

### ubcLogger.stopTimingLog([label])
stopTimingLog 停止时长计算

**Kind**: instance method of [<code>UbcLogger</code>](#UbcLogger)  

| Param | Type | Default | Description |
| --- | --- | --- | --- |
| [label] | <code>\*</code> | <code>default</code> | 时长打点必须拥有唯一的名字，默认default |

**Example**  
```js
ubclogger.stopTimingLog('timing1');
```
<a name="UbcLogger+getVersion"></a>

### ubcLogger.getVersion() ⇒ <code>string</code>
getVersion 获得当前sdk版本

**Kind**: instance method of [<code>UbcLogger</code>](#UbcLogger)  
**Returns**: <code>string</code> - 当前sdk版本  


## 从@baidu/ubc-report-sdk@2.x迁移
### 初始化
```js
ubc('init', server_id , configs)
// 等价于
ubcLogger.set({
    serverId: server_id,
    ...configs
})

```
### 事件打点
```js
ubc('event', options[, callback])
// 等价于
ubcLogger.send(options).then(callback);

// 如果单条请求需要使用sendBeacon
ubcLogger.send(options, {
    useSendBeacon: true
}).then(callback);
```

### 时长打点
```js
新版时长需要重新实例化话一个UbcLogger，serverId为原本的timingId
const timeLogger = new UbcLogger({
    serverId:timingId,
    duration: 5
})
// 时长统计起始时间发送
ubc('timing', 'start', eventName,value,ext);
// 等价于
timeLogger.startTimingLog(eventName, {
    value,
    ext
});

// 时长统计结束时间发送
ubc('timing', 'end', eventName);
// 等价于
timeLogger.stopTimingLog(eventName);
```

### 页面PV
旧版页面pv为挂载sdk时打点，新版sdk中页面pv的计算为用每一次将页面从后台唤醒到前台
```js
ubc('pv', 'pageName');
//等价于

ubcLogger.send({
    page: 'pageName'
});
```

### 多实例
```js
// 旧版
ubc('secondTracker.init', '10005', {
    testMode: true,
    page: 'home',
    from: 'act'
});
ubc('secondTracker.event', ...);
// 新版
const secondUbcLogger = new UbcLogger({
    serverId: '10005',
    testMode: true,
    page: 'home',
    from: 'act'
})

secondUbcLogger.send(...);

### 移除部分参数

- 移除了version，现在仅支持ubc规范 2.0
- 移除了autoPvTrack，需要使用者自己添加pv打点
- 移除了autoTimingTrack，需要使用者在页面展现时启动一个时长打点

```
## 打点校验

目前日志中台采用了新的打点校验方式 http://feedlog.baidu-int.com/logap#/logConfig/JournalChecksumming/Online?id=99

设置`testMode: true`，并扫描校验页面的二维码，即可上报打点进行校验。如果需要停止当前手机的日志的收集，可以清除手机的cookie以及设置`testMode=false`

![demo](https://efe-h2.cdn.bcebos.com/ceug/resource/res/2022-04/1650013442483/ca7vad5e1pbu.png)

如果需要进行rpc联调，或者走老的校验平台，可以设置testUrl

```js
ubcLogger.set({
    testMode: true,
    testUrl: 'http://bjyz-mco-searchbox201609-m12xi3-044.bjyz.baidu.com:8080/ztbox'
})
```

> sdk 3.1.0 及之后的版本不再自动向线下地址发送日志

## 注意事项

1. cuid由矩阵产品（比如手百）向请求的cookie中写入的(BAIDUCUID)
2. 用户标识有两种`BDUSS`和`BAIDUID`，前者由端写入，所以端外不存在；后缀为服务器端写入，但需要当前域名为.baidu.com（所以.baidu-int.com下不存在BAIDUID）


## 相关文档
1. apptype对应的应用列表 http://app.baidu-int.com/console/application/clientlist
2. 问题总结 http://agroup.baidu.com/share/md/5335086ff2c246c4b88082a2a3bc06f5

