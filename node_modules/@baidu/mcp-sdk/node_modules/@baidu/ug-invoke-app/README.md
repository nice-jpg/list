# ug-invoke-app

MEG底层调起SDK。

[【点击查看内网线上demo-->】](http://zhangsiyuan-2077.bcc-bdbl.baidu.com:8833/test.html)

## 目标

统一MEG调起APP的流程，简化开发，提高调起率。

## 设计文档

http://agroup.baidu.com/share/md/a3dbd3e35dcf4d81bbe3cc9deeada6d4

## 安装 && 版本

`npm --registry=http://registry.npm.baidu-int.com i @baidu/ug-invoke-app`

## 业务编译相关

`@baidu/ug-invoke-app`默认提供的是一份esNext模块的源码，没有压缩和minify,且dependency依赖外置。
这样做的好处是，业务上可以根据自己的需求，最终只做一次编译，获取最小的线上包，也不会有多次编译带来的冗余代码、runtime、polyfill。
对于使用webpack做最终编译的业务来说，js文件编译需要对某些node_modules的模块做babel解析，将这些模块编译成es5代码。

以下是一份完整的ug-invoke-app在业务中的babel-loader配置：

```js
// webpack 配置示例
// 大部分的node_modules不过babel编译，除了括号中的几个
// 这样可以确保ug-invoke-app及相关依赖都可以编译成es5模块
const babelLoaderOptions = {
    test: /\.js$/,
    exclude: /node_modules\/(?!(@baidu\/ug-invoke-app|@baidu\/ug-error-log|@baidu\/eop-utils|query-string|strict-uri-encode|split-on-first|clipboard\/src)\/).*/,
}
```

### 单文件es6版

```js
import {invokeApp} from '@baidu/ug-invoke-app/dist/singleFile.js'
```

如果不需要上面的精细化的依赖复用，可以使用这个版本，编译上更轻松。

## 从V1迁移

2.0版本使用了typescript重构，可以提供完备的类型提示和自动完成。

内部重新设计了调起路径，确保调起时机和特殊case规则简单可依赖。

编译体积从原来的13.5k gzip缩减到现在的5k gzip。

#### api变动

V2提供了5个API，分别是调起invokeApp|invokeTpApp、调起安卓应用商店invokeMarket、获取当前浏览器信息getHostInfo、生成微信标签createWxTag，而且参数和之前有细微的差别，需要开发者仔细对照文档更新。

#### invokeApp的返回值

返回类型为`Promise<Status>`，不再包含msg。

同时，具体的Status也和之前有不同，请仔细检查文档中的statusCode.

#### useDeeplink默认为false

使用deeplink端能力，需要目标端在手百scheme调起白名单内，如果真的有这个需求，需要业务方自行确认在白名单中再开启。
[申请流程文档->](http://wiki.baidu.com/pages/viewpage.action?pageId=705920851)
联系@caijunkai

## 注意！

【ios写剪贴板有系统限制】，不能静默或者异步写入，所以一定要先请求，再执行调起。

**不可以点击后发起请求，异步结果回来后执行调起。**

## 用户如流群

3924053

## API

### invokeApp

`invokeApp`是对外暴露的核心Api，使用者只需要传入必要的信息完成端App的调起。

对于大部分需求，只需要关心必须参数+scheme即可，非必须参数一定要在理解的基础上再使用。有疑问可以随时在用户群`3924053`里沟通。
比如ulink参数，这是给自行控制ulink链接的业务方提供的，大部分普通需求都不会用到，因为sdk内部已经做了动态拼接的逻辑，会在ios机型上默认使用universal link调起，在安卓机型上默认使用scheme调起。

**useDeeplink参数，依赖手百端能力白名单，请业务方确认被吊起的目标端在手百白名单内，再设置成ture。**

| 目前支持的APP |是否支持ulink |
| :----:     | :----: |
| 百度    |   是   |
| 百度极速版    |   是   |
| 好看视频    |   是   |
| 全民小视频    |   是   |
| 贴吧    |   否   |
| 百度网盘    |   是   |
| 爱奇艺    |   是   |
| 地图    |   是   |
| 番乐    |   是   |
| 百度文库    |   否   |
| 柠檬爱美    |   是   |
| 百度输入法    |   是（不支持自定义中间页）   |
| 百度看看    |   是   |
| 微叭    |   否   |
| 有驾    |   否   |
| 宝宝知道    |   否   |
| 一刻相册    |   是（不支持自定义中间页）   |
| 百度汉语    |   是   |
| 有噗    |   是   |
| 百度大字版    |   是   |
| 古物潮玩    |   是   |
| 一局    |   是   |
| 百度健康    |   是   |
|  不挂科   |   否   |
|  音磁 rap  |   是   |
|   随音 wepod  |   是   |
|  yy  |   是(不支持自定义中间页)   |
|  小米白牌  |   否   |
|  百度关怀版  |   是   |
|  小度  |   是   |

以上appName可以从下面文档中查到。
[appName命名规范查询>](http://agroup.baidu.com/share/md/4d5c71664d234e429016e1a9a5fda4eb)

#### 参数

| 参数    |是否必须 | 类型 | 说明 | 默认值|
| :----:     | :----: | :----: | :----: | :----: |
| appName    |   是   | string | 矩阵APP名 |-|
| token      |   否   | string | 口令 |-|
| scheme     |   否   | string | 直接调起的scheme，默认为端的首页 |自带可用调起scheme|
| toStore    |   否   | boolean | 调起失败后是否进入对应app应用商店页面|true|
| toYYB      |   否   | boolean | 微信内调起失败后是否进入应用宝|true|
| timeout    |   否   | number | 调起超时时间（单位ms）|2000|
| ulink      |   否   | string | IOS调起使用的universal link，**极特殊情况**才需要自行传入。 |自带可用链接|
| useDeeplink   |   否   | boolean | 是否在矩阵内使用deeplink |false|
| useNotTryJump |   否   | boolean | 是否回避黑名单浏览器，这些浏览器会直接调起失败，走失败流程，体验上会更快些 |true|
| checkTokenCopied |   否   | boolean | 口令复制失败时是否中断调起 |true|
| failedUrl |   否   | string | 调起失败后兜底链接 |调起失败的中间页url，如果toStore为false，那么ios ulink会回退到这个url上|
| apkUrl|   否   | string | Android App下载链接 |默认不下载|
| iosStoreUrl |   否   | string | 苹果商店链接，应该只有需要自己拼接ios store url进行苹果统计的业务才需要 |默认无|
| stateRatio |   否   | number类型：0、10、20、30、50、100  | 打点统计比例，默认抽10%，只是内部监控，不能作为线上统计 |10|

#### 返回值

|  返回值 | 类型 | 描述 |
| :----: | :----: | :---- |
| status | number | 调起成功定义`promise.resolve`:<br>10000: app或universal link调起成功<br>10001: 应用商店调起成功<br>10002: 下载链接调起成功<br>10003: 在安卓微信中应用宝调起成功<br>10004: failedUrl调起成功<br>调起失败定义`promise.reject`:<br>20004: 口令复制失败<br>20005: toStore、downloadUrl为false时，调起失败(调起APP时失败)<br>20006: 不支持此系统<br>20007: downloadUrl为false时，调起失败(调起APP及应用商店时失败)<br>20008: IOS系统下调起universal link失败<br>20011: 不支持的appName，请检查AppName属性和当前版本|

#### demo

```js
import {invokeApp} from '@baidu/ug-invoke-app';

invokeApp({
    appName: 'baiduboxapp',
    token: '^NK1Exbe1l9^',
    scheme: 'baiduboxapp://v1/easybrowse/hybrid?upgrade=1&type=hybrid&tpl_id=landing_app.html&newbrowser=1&style=%7B%22toolbaricons%22%3A%7B%22tids%22%3A%5B%224%22%2C%221%22%2C%222%22%2C%223%22%5D%2C%22menumode%22%3A%222%22%2C%22actionBarConfig%22%3A%7B%22extCase%22%3A%220%22%7D%7D%7D&slog=%7B%22from%22%3A%22feed%22%7D&context=%7B%22nid%22%3A%22news_9435701338559160459%22%7D&ch_url=https%3A%2F%2Fmbd.baidu.com%2Fnewspage%2Fdata%2Flandingreact%3FpageType%3D2%26nid%3Dnews_9435701338559160459%26uk%3DiJJyATMjvuTWzyTXB394lA%26sourceFrom%3DlandingShare&commentInfo=%7B%22topic_id%22%3A1089000037075654%2C%22opentype%22%3A2%7D&logargs=%7B%22source%22%3A%221021199s%22%2C%22channel%22%3A%221021203s%22%7D&needlog=1'
})
    .then(res => {
        // 返回值为10000这样的statusCode
        console.log(res)
    })
    .catch(err => {
        // 返回值为20001这样的statusCode
        console.log(err)
    });
```

---

### invokeTpApp

2.2.0新增的api，用来调起第三方App，非百度系，比如抖音、小红书等。

#### 参数

|  参数   |是否必须 | 类型 | 说明 | 默认值|
|:----------:| :----: | :----: | :----: | :----: |
|   token    |   否   | string | 口令 |''|
|   scheme   |   是   | string | 直接调起的scheme |无，必须填写哦|
|  toStore   |   否   | boolean | 调起失败后是否进入对应app应用商店页面|false|
|   toYYB    |   否   | boolean | 微信内调起失败后是否进入应用宝|false|
|  timeout   |   否   | number | 调起超时时间（单位ms）|2500|
|   ulink    |   否   | string | IOS调起使用的universal link，请业务方拼好再传入 |''|
| checkTokenCopied |   否   | boolean | 口令复制失败时是否中断调起 |true|
| failedUrl |   否   | string | 调起失败后兜底链接 |无|
|apkUrl |   否   | string | Android App下载链接 |默认不下载|
|pkgName |   否   | string | Android App包名，当toYYB、toStore有一个为true时，强制需要pkgName |''|

#### 返回值

|  返回值 | 类型 | 描述 |
| :----: | :----: | :---- |
| status | number | 调起成功定义`promise.resolve`:<br>10000: app或universal link调起成功<br>10001: 应用商店调起成功<br>10002: 下载链接调起成功<br>10003: 在安卓微信中应用宝调起成功<br>10004: failedUrl调起成功<br>调起失败定义`promise.reject`:<br>20004: 口令复制失败<br>20005: toStore、downloadUrl为false时，调起失败(调起APP时失败)<br>20006: 不支持此系统<br>20007: downloadUrl为false时，调起失败(调起APP及应用商店时失败)<br>20008: IOS系统下调起universal link失败<br>20011: 不支持的appName，请检查AppName属性和当前版本<br>21000: 参数错误|

#### demo

```js
import {invokeTpApp} from '@baidu/ug-invoke-app';

invokeTpApp({
    "pkgName": "com.xingin.xhs",
    "scheme": "xhsdiscover://user/5f12d8cf0000000001004c15",
    "toStore": true,
    "token": "testToken",
    "failedUrl": "https://baidu.com"
})
    .then(res => {
        // 返回值为10000这样的statusCode
        console.log(res)
    })
    .catch(err => {
        // 返回值为20001这样的statusCode
        console.log(err)
    });
```

---

### invokeMarket

`invokeMarket`是调起安卓应用商店的方法

#### 参数

|  参数     | 是否必须 | 类型 | 说明 | 默认值 |
| :----:   | :----: | :----: | :----: | :----: |
| pkgName  |   是   | string | app的安卓包名 | - |
| timeout  |   否   | number | 调起超时时间（单位ms） | 2000 |

#### 返回值

|  返回值 | 类型 | 描述 |
| :----: | :----: | :---- |
| status | number | 调起成功10001，调起失败20007|

#### demo

```javascript
invokeMarket('com.baidu.searchbox', 2000)
    .then(res => {
        // 10001
        console.log(res);
    })
    .catch(e => {
        // 20007
        console.log(e);
    });
```

---

### getHostInfo

获取宿主浏览器名称及版本，支持获取大部分市面上的浏览器环境

#### 返回值

|  返回值 | 类型 | 描述 |
| :----: | :----: | :---- |
| browser | string | 所在端name，baiduhaokan、baiduboxapp等|
| brand | string | 手机品牌 oppo、huawei等  |
| os | string | android/ios/-  |

#### demo

```javascript
const {browser, brand, os} = getHostInfo();

// wechat, huawei
console.log(brwoser, brand, os)
```

---

### createWxTag

创建微信开放标签，仅可在安卓微信环境中调起手百使用(IOS微信中有Ulink，没必要用这个)。

此接口会生成一个dom，填充满整个传入的父元素，需要父元素设置position。

#### 使用条件

1. 微信环境中
2. appid已在sdk中注册过
3. 域名在微信开放平台中绑定完毕

#### 参数

|    参数     | 是否必须 |    类型    |           说明           |     默认值     |
|:---------:|:----:|:--------:|:----------------------:|:-----------:|
|  appName  |  否   |  string  |         矩阵APP名         | baiduboxapp |
| targetDom |  是   |  Object  | 需要插入微信开放标签的dom元素，作为父元素 |      -      |
|  wxInfo   |  是   |  Object  |      微信开放标签需要的参数       |      -      |
|  scheme   |  否   |  string  |  对应微信开放标签中的extinfo参数   | 默认首页scheme  |
|   token   |  否   |  string  |        需要复制的口令         |      -      |
|  openYYB  |  否   | boolean  |       失败后是否打开应用宝       |    true     |
|   debug   |  否   | boolean  |         开启调试模式         |    false    |
|  onClick  |  否   | Function |      点击开放标签时的回调方法      |      -      |
| onSucceed |  否   | Function |       调起成功时的回调方法       |      -      |
| onFailed  |  否   | Function |       调起失败时的回调方法       |      -      |

#### 返回值

|  返回值   |   类型   | 描述                                                        |
|:------:|:------:|:----------------------------------------------------------|
| status | number | 状态码：<br/>10000: 调起成功<br/>20005: 调起失败<br/>20012: 不支持微信开放标签 |
|  msg   | string | 附带信息                                                      |

#### demo

```javascript
import {createWxTag} from '@baidu/ug-invoke-app';

const targetDom = document.querySelector('.wx-tag');
createWxTag({
    appName: 'baiduboxapp',
    targetDom,
    wxInfo: PAGE_DATA.pageData.wxInfo,
    onClick: function () {
        console.log('click');
    },
    onSucceed: function (e) {
        console.log('success!', e);
    },
    onFailed: function (e) {
        console.log('failed!', e);
    },
});
```

## Q & A

http://agroup.baidu.com/share/md/f46fff6ba7ca439d9d7027b16e7fd637
