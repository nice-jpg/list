/**
 * @file toOauth.js
 * @author renzhonghua@baidu.com
 * @description 调用鉴权端能力逻辑
 */

var getSchemeHead = require('./getSchemeHead');
var oauthApi = require('./oauthApi');
// var Promise = require('es6-promise');

return function (opt) {
    return new Promise(function (resolve, reject) {
        var exchangeMap = {};
        var toAppList = [];

        if (opt.oauth.schemeList.length) {
            var schemeList = opt.oauth.schemeList;
            for (var i = 0; i < schemeList.length; i++) {
                if (getSchemeHead(schemeList[i])) {
                    var head = getSchemeHead(schemeList[i]);
                    toAppList.push(head);
                    exchangeMap[head] = {
                        name: schemeList[i]
                    };
                }
            }
        }

        oauthApi({
            name: 'public-oauth',
            data: {
                ext: opt.oauth.ext || {},
                type: opt.id || '',
                schemeList: toAppList
            }
        }).then(function (res) {
            var result = [];
            if (res && res.schemeList) {
                for (var i = 0; i < res.schemeList.length; i++) {
                    var item = res.schemeList[i];
                    if (item.tag !== '0' && exchangeMap[item.name]) {
                        result.push(exchangeMap[item.name].name);
                    }
                }
            }

            resolve({
                errCode: 0,
                errMsg: 'success',
                data: {
                    schemeList: result,
                    expireTime: res.expireTime || ''
                }
            });
        }).catch(function (res) {
            reject(res);
        });
    });
};
