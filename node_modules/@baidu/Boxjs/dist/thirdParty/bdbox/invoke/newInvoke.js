
var $ = require('@baidu/Boxjs/dist/utils/_bdboxWrapper')
/* eslint-disable */
/**
 * 新调起协议封装
 */
/*jshint -W802,-W079*/

var version_compare = require('../utils/version_compare');
var getVersion = require('../utils/getVersion');

return function(action, params, callback) {
    //baiduboxapp://version/component/module/../action?k1=$v1&k2=$v2..&upgrade=1
    if (!action || !$.$isBox() && !$.$isLiteBox()) {
        return;
    }

    var url = [], scheme;
    if ($.isFunction(params)) {
        callback = params;
    } else {
        for (var i in params) {
            url.push(i + '=' + params[i]);
        }
    }
    if ($.isFunction(callback)) {
        var funcName = '_bdbox_js_' + $.getId();
        window[funcName] = function() {
            callback.apply(window, ([]).slice.call(arguments, 0));
            /*delete window[funcName];*/
        };
        url.push('callback=' + funcName);
    } else {
        if (callback) {
            url.push('callback=' + callback);
        }
    }
    scheme = 'baiduboxapp://' + action + '?' + url.join('&');

    var version = getVersion();
    var androidJsBridge = window.Bdbox_android_jsbridge;
    if ($.$isAndroid() && version_compare(version, '9.0') >= 0) {
        // 安卓系统 手百9.0的jsbridge
        if (androidJsBridge && androidJsBridge.dispatch) {
            androidJsBridge.dispatch(scheme);
        } else {
            window.prompt('BdboxApp:' + JSON.stringify({
                obj: 'Bdbox_android_jsbridge',
                func: 'dispatch',
                args: [scheme]
            }));
        }
        return;
    }

    var $node = document.createElement('iframe');
    $node.style.display = 'none';
        $node.src = scheme;
    var body = document.body || document.getElementsByTagName('body')[0];
    body.appendChild($node);
    // 销毁 iframe
    setTimeout(function() {
        body.removeChild($node);
        $node = null;
    }, 0);
};
