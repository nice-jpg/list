
var $ = require('@baidu/Boxjs/dist/utils/_bdboxWrapper')
var monitor = require('./monitor');
var extend = require('../extend');
var query2Json = require('../utils/queryToJson');
var getVersion = require('../utils/getVersion');

//url中存在公共参数，则给tcbox拼上，透传
var URL = query2Json(location.search);

var ua = navigator.userAgent;
var GIF_URI = '//m.baidu.com/tcbox';
var CUSTOM_ARG = {
    service: 'bdbox',
    action: 'pblog',
    ctv: 2, //表明参数协议第二个版本
    cen: 'uid_ua_ut', //表明参数加密
    data: {
        dataid: '2', //客户端：1、JS：2、SERVER：3
        actiontype: '1', //区分主动/被动行为，主动：1、被动：0
        actionid: '2', //写死, actionid：2=事件统计，1=pv统计
        actiondata: {
            ref: URL.ref || '',
            gmv: URL.vmgdb || '',
            source: URL.from || URL.ref || '',
            boxVersion: getVersion(),
            boxPlatform: ua.match(/(iPad|iPhone|iPod)/igm) ? 'ios' : 'android'
        }
    }
};
var urlencode = encodeURIComponent;


if (URL.uid && URL.osname) {
    var arr = [];
    ['osname', 'ua', 'ut', 'from', 'cfrom', 'uid', 'pkgname'].forEach(function(v) {
        URL[v] && (CUSTOM_ARG[v] = URL[v]);
    });
}

var TC = monitor(GIF_URI, {
    customHandler: function(url) {
        var arr = [];
        for (var i in CUSTOM_ARG) {
            if (CUSTOM_ARG.hasOwnProperty(i)) {
                var val = CUSTOM_ARG[i];
                if ($.isObject(val)) {
                    val = JSON.stringify(val);
                }
                arr.push(i + '=' + urlencode(val));
            }
        }
        if (arr.length) {
            url += arr.join('&');
        }
        return url;
    }
});
TC.init = function(obj) {
    CUSTOM_ARG = obj;
}

/**
 * pv统计
 * @param  {string} url 统计的pv url
 * @param  {string} su  来源url，可选
 * @return {this}     TC
 */
TC.pv = function(url, u) {
    var _data = CUSTOM_ARG.data;
    _data.actionid = '1'; ////写死, actionid：2=事件统计，1=pv统计
    var data = {};
    if (url) {
        data.url = url;
    }
    if (u) {
        data.u = u;
    }
    _data.actiondata = extend(_data.actiondata, data);
    return TC.report();
}

/**
 * /searchbox?action=pblog&service=bdbox&pu=六大公共参数data={
    "dataid":"__DATA_ID__", //区分sdk客户端：1、JS：2、SERVER：3
    "cateid":"__CATE_ID__", // 区分业务 卡片、小说、视频…
    "actionid":"__ACTION_ID__", //区分行为
    "actiontype":"__ACTION_TYPE__", //区分主动/被动行为，主动：1、被动：0
    "actiondata":"__ACTION_DATA__", //业务具体数据，json格式
}

 */


/**
 * tc统计
 * @param  {number} cateId 业务id,比如卡片、小说、视频等，找伟达申请
 * @param  {object} data   数据对象
 */
TC.tc = function(cateId, data) {
    var _data = CUSTOM_ARG.data;
    _data.actionid = '2'; ////写死, actionid：2=事件统计，1=pv统计
    if (!$.isPlainObject(cateId)) {
        _data.cateid = cateId + '';
    } else {
        data = cateId;
    }
    console.warn('tc方法不再支持，请使用pblog');
    _data.actiondata = extend(_data.actiondata, data);
    return TC.report();
}

/**
 * 事件打点统计
 * @param  {string} cateId 业务id,比如卡片、小说、视频等，找伟达申请
 * @param  {string} evtName 事件名称
 * @param  {string} evtType   事件类型
 * @param  {string} evtTag    事件tag标示
 * @return {object}  tc    tc函数
 */
TC.event = function(cateId, evtName, evtType, evtTag) {
    // console.log(arguments);
    if (!evtName) {
        throw 'monitor.tc.event need a evtName';
    }
    var data = {
        evtName: evtName,
        evtType: evtType || '',
        evtTag: evtTag || ''
    };
    return TC.tc(cateId, data);
}

/**
 * tcbox, 事件跟踪
 * @memberOf Bdbox.monitor
 * @name  tc
 * @author wangyongqing01
 * @version $Id: tc.js 286585 2016-03-15 11:57:15Z wangyongqing01 $
 * @example
 * init方法一般不使用
 * Bdbox.monitor.tc('init',[{}])
 * //统计PV
 * Bdbox.monitor.tc('pv')
 * //统计事件
 * Bdbox.monitor.tc('event',[cateid, {eventName:xxx,a:1}])
 * onclick="Bdbox.monitor.tc('event',[cateid, {eventName:xxx,a:1}])"
 *
 * @version $Id: tc.js 286585 2016-03-15 11:57:15Z wangyongqing01 $
 */
return function() {
    TC.main.apply(TC, arguments);
    //return TC.report('ep=' + urlencode(ep.join('*')) + '&et=4');
};
