
var $ = require('@baidu/Boxjs/dist/utils/_bdboxWrapper')
/* eslint-disable */
/**
 * 分享
 * @memberOf Bdbox.client
 * @name share
 * @version $Id$
 * @example
 * Bdbox.client.share({
 *     'content': 'xxxx',
 *     'title': 'xxxx',
 *     'linkUrl': 'xxxx',
 *     'iconUrl': 'xxx',
 *     'success': function(){},
 *     'error': function(){}
 * });
 * //设置通用native分享
 * Bdbox.client.share.setNative({
 *     'xxx': xx
 * });
 */
/* jshint -W802 */
var getVersion = require('../utils/getVersion'),
  version_compare = require('../utils/version_compare'),
  A_NAMESPACE = 'Bdbox_android_utils',
  version = getVersion(),
  ios_invokeApp = require('../ios/invokeApp'),
  android_invokeApp = require('../android/invokeApp')

var self = function (options, sc, ec) {
  var defalutOpt = {
      'mediaType': 'all',
      'title': document.title,
      'content': document.title,
      'linkUrl': location.href,
      'imageUrl': '',
      'iconUrl': '',
      'source': 'bdbox',
      'type': 'url'
    },
    attr,
    successcallback = handleCallback(sc),
    errorcallback = handleCallback(ec)

  for (attr in defalutOpt) {
    if (!options.hasOwnProperty(attr) && options[attr]) {
      options[attr] = defalutOpt[attr]
    }
  }

  if (($.$isBox() && version_compare(version, '5.3.5') >= 0) || $.$isLiteBox()) {
    if ($.$isIOS()) {
      opt = JSON.stringify(options)
      ios_invokeApp('callShare', {
        'options': encodeURIComponent(opt),
        'successcallback': successcallback,
        'errorcallback': errorcallback
      })
    } else {
      if ($.$isBox() && version_compare(version, '6.5') < 0) {
                // android有了imageUrl就是图片分享，但是去掉，微博就是截图分享，orz
        delete options.imageUrl
      }
      android_invokeApp(A_NAMESPACE, 'callShare', [JSON.stringify(options), successcallback, errorcallback])
    }
  }
}

var handleCallback = function (cb) {
  cb = cb || 'console.log'
  if ($.isFunction(cb)) {
    var cbname = '_shareCB_' + $.getId()
    window[cbname] = cb
    cb = cbname
  }
  return cb
}
self.setNative = function (opt) {
  var sucName = handleCallback(opt.success),
    failName = handleCallback(opt.error)
  delete opt.success
  delete opt.error

    // native和顶部[...]分享配置
  var BoxShareData = {
        // 成功回调函数名，经过测试and6.5以上微信分享success可用，ios可用
    successcallback: sucName,
        // 失败回调函数名，android6.5及其以下分享fail均不可用
    errorcallback: failName,
    options: opt
  }
  if ($.$isAndroid() && $.$isBox() && version_compare(version, '6.5') < 0) {
        // android有了imageUrl就是图片分享，但是去掉，微博就是截图分享，orz
    delete BoxShareData.options.imageUrl
  }
  window.BoxShareData = BoxShareData
}
return self
