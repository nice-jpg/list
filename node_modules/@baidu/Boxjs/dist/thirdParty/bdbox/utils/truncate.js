
var $ = require('@baidu/Boxjs/dist/utils/_bdboxWrapper')
/**
 * 多行截断
 * 在需要截断的子节点元素上添加data-truncate=true
 * @memberOf Bdbox.utils
 * @name truncate
 * @function
 * @param {Object} 父节点元素
 * @param {Number} 需要显示的行数
 * @param {String} 后缀字符(默认是...)
 * @example
 * truncate($("#aaa"), 3, "...");
 * @author pengkuan
 */

function truncate(container, lineNum, postfix) {
	var $ = Zepto;
	if (!(container && lineNum > 0)) {
		return;
	}

	var $c = $(container);

	$.each($("*[data-truncate=true]", $c), function(i, elem) {
		var $elem = $(elem),
			height = $elem.height(),
			paddingTop = $elem.css("padding-top"),
			paddingBottom = $elem.css("padding-bottom"),
			borderTop = $elem.css("border-top-width"),
			borderBottom = $elem.css("border-bottom-width"),
			lineHeight = $elem.css("line-height"),
			fontSize = $elem.css("font-size");

		paddingTop = (paddingTop && paddingTop.indexOf("px") > -1) ? paddingTop.substr(0, paddingTop.length - 2) : 0;
		paddingBottom = (paddingBottom && paddingBottom.indexOf("px") > -1) ? paddingBottom.substr(0, paddingBottom.length - 2) : 0;
		borderTop = (borderTop && borderTop.indexOf("px") > -1) ? borderTop.substr(0, borderTop.length - 2) : 0;
		borderBottom = (borderBottom && borderBottom.indexOf("px") > -1) ? borderBottom.substr(0, borderBottom.length - 2) : 0;

		/* 内容区域的实际高度 */
		height = height - paddingTop - paddingBottom - borderTop - borderBottom;

		lineHeight = (lineHeight && lineHeight.indexOf("px") > -1) ? lineHeight.substr(0, lineHeight.length - 2) : 0;
		fontSize = (fontSize && fontSize.indexOf("px") > -1) ? fontSize.substr(0, fontSize.length - 2) : 0;
		lineHeight = (lineHeight) > 0 ? lineHeight : fontSize;

		var targetHeight = lineHeight * lineNum;

		/* 内容区域高度大于目标高度则进行截断操作 */
		if (height > targetHeight) {

			/* 先将padding-top、padding-bottom、border-top、border-bottom的值置为0 */
			$elem.css({
				"padding-top": "0px",
				"padding-bottom": "0px",
				"border-top-width": "0px",
				"border-bottom-width": "0px"
			});

			postfix = postfix ? postfix : "...";
			var txt = $elem.html(),
				newTxt = txt + postfix,
				postfixLength = postfix.length;
			while ($elem.height() > targetHeight) {
				newTxt = newTxt.substr(0, newTxt.length - (postfixLength + 1)) + postfix;
				$elem.html(newTxt);
			}

			/* 先将padding-top、padding-bottom、border-top、border-bottom的值恢复 */
			$elem.css({
				"padding-top": paddingTop + "px",
				"padding-bottom": paddingBottom + "px",
				"border-top-width": borderTop + "px",
				"border-bottom-width": borderBottom + "px"
			});
		}
	});
}

return truncate;
