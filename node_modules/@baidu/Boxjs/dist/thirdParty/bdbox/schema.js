
var $ = require('@baidu/Boxjs/dist/utils/_bdboxWrapper')
/* eslint-disable */
/**
 * 使用schema协议调起app
 *
 * @memberOf Bdbox
 * @function
 * @name schema
 * @param  {String} url schema协议，比如`baiduboxappv5://openxxx?abc=fff`
 * @param  {Function} callback 回调函数，接收一个参数isTimeout
 * @example
 * Bdbox.schema('baiduboxapp://', function(isTimeout) {
 *   if (isTimeout) {
 *       console.log('通过isTimeout是true，判断没有安装');
 *   } else {
 *       console.log('成功');
 *   }
 * });
 * @version $Id: schema.js 286319 2016-03-14 08:25:23Z wangyongqing01 $
 */

var os = require('./utils/detect')(),
    versionCompare = require('./utils/version_compare'),
    ready = require('./utils/ready'),
    timer = null;

function schema(url, callback) {
    if (!url) {
        //为空的情况
        callback(true);
        return;
    }
    callback = callback || $.emptyFn;

    if (!$.$isBox() && $.$isIOS() && versionCompare(os.version, '9.0') >= 0) {
        // 非框，iOS 9.0+，domready时使用location.href
        ready(function() {
            fallback(url, callback);
        });
        return;
    }

    // 记录起始时间
    var last = Date.now();
    // 创建一个iframe
    var ifr = document.createElement('IFRAME');
    ifr.src = url;
    // 飘出屏幕外
    ifr.style.position = 'absolute';
    ifr.style.left = '-2000px';
    ifr.style.top = '-1000px';
    ifr.style.width = '1px';
    ifr.style.height = '1px';
    // 设置一个4秒的动画用于检查客户端是否被调起
    ifr.style.webkitTransition = 'all 0.9s';
    ifr.style.transition = 'all 0.9s';
    document.body.appendChild(ifr);
    var end = function() {
        document.body.removeChild(ifr);
        if (Date.now() - last < 1500) {
            // 如果动画执行时间在预设范围内，就认为没有调起客户端
            callback(true);
        } else {
            // 动画执行超过预设范围，认为调起成功
            callback(false);
        }
    }

    // 监听动画完成时间
    ifr.addEventListener('webkitTransitionEnd', end, false);
    ifr.addEventListener('transitionEnd', end, false);
    setTimeout(function() {
        // 启动动画
        ifr.style.left = '-1000px';
    }, 20);
}

function fallback(url, callback) {
    location.href = url;

    timer && clearTimeout(timer);
    timer = setTimeout(function() {
        callback(true);
    }, 3000);
}

return schema;
