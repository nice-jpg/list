
var $ = require('@baidu/Boxjs/dist/utils/_bdboxWrapper')
/**
 * @file profile
 * @author unknown
 */

/* global Zepto */

;(function ($) {
    $.fn.picLazyLoad = function (settings) {
        var $this = $(this);
        var winScrollTop = 0;
        var winHeight = $(window).height();

        settings = $.extend({
            threshold: 500, // 提前高度加载
            placeholder: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6Q'
                + 'AAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC'
        }, settings || {});

        settings.animate && $this.css({
            transition: 'all 1s ease 0.5s',
            webkitTransition: 'all 1s ease 0.5s'
        });

        $this.each(function (index, el) {
            var $self = $(this);
            if ($self.attr('data-original')) {
                settings.animate && $this.css({
                    opacity: 0
                });
            }
        });

        // 执行懒加载图片
        lazyLoadPic();
        // 滚动触发换图
        var timer = null;
        $(window).on('scroll', function () {
            if (timer) {
                clearTimeout(timer);
            }
            timer = setTimeout(function () {
                winScrollTop = $(window).scrollTop();
                lazyLoadPic();
            }, 100);
        });
        // 懒加载图片
        function lazyLoadPic() {
            $this.each(function () {
                var $self = $(this);
                var src = '';
                // 如果是img
                if (src = $self.attr('data-original')) {
                    var offsetTop = $self.offset().top;
                    var imgObj = new Image();

                    if ((offsetTop - settings.threshold) <= (winHeight + winScrollTop)) {
                        if ($self.is('img')) {
                            imgObj.src = src;
                            imgObj.onload = function () {
                                $self.attr('src', src).removeAttr('data-original');
                                settings.animate && $self.css({
                                    opacity: '1'
                                });
                            };
                        }
                        else {
                            var css = {
                                backgroundImage: 'url(' + src + ')'
                            };
                            if (settings.animate) {
                                css.opacity = '1';
                            }
                            imgObj.src = src;
                            imgObj.onload = function () {
                                $self.removeAttr('data-original').css(css);
                            };

                        }

                    }
                }

            });
        }
    };
})(Zepto);
