module.exports = function () {
  var $ = require('boxjs/dist/utils/_bdboxWrapper');
  /**
   * @file
   * Created by lihuiqing on 2016/07/22.
   * http://agroup.baidu.com/box/md/view/113145
   * @param {Object} opts
   * @@ pagetype: 如 feednews feedvideo
   * @@ pageid: 12345678
   * @@ cateid:pblog 打点 cateid
   * @@ logselecter:要统计的item 样式
   * @@ footermaskslecter 可选参数，如遮罩评论框容器的样式名
   * ps: 页面要统计的元素必须带有data-realshowlog 属性，值为字符串，其中包含 要统计的数据 如 <li data-realshowlog="123456789"></li>
   */


  var pblog = require('./pblog');

  var getABTestSidList = require("../utils/getABTestSidList");

  var _sid;
  /**
   * @todo,待拆出
   * 获取 Sid 列表，拼接 sid 参数，格式如下：
   * sid=testId_componentKey-testId_componentKey 例如：sid=34_1-1000014_3
   */


  getABTestSidList(function (data) {
    if (data && data.length > 0) {
      var sidList = [];

      for (var i in data) {
        sidList.push(data[i][0] + '_' + data[i][1]);
      }

      _sid = sidList.join('-'); // console.log(_sid);
    }
  });
  return function (opts) {
    //初始化 pblog 打点
    pblog('init', [opts.cateid]); //初始化 pblog

    var logDomsTotal = document.querySelectorAll(opts.logselecter);
    var start = 0;
    var end = 0;
    var max = logDomsTotal.length;
    varscrollTop = document.body.scrollTop;
    var screenHeight = document.documentElement.clientHeight;

    if (opts.footermaskslecter) {
      screenHeight -= document.querySelector(opts.footermaskslecter).clientHeight;
    }
    /**
     * 实际展现元素打点
     */


    function logShow() {
      var logArr = [];
      [].forEach.call(logDomsTotal, function (v, i) {
        var dom = logDomsTotal[i];
        var domTop = dom.getBoundingClientRect().top;

        if (domTop < screenHeight) {
          if (i >= start) {
            logArr.push(dom.getAttribute('data-realshowlog'));
            end = i;
            start = end + 1;
          }
        } else {
          return false;
        }
      });
      logArr.length > 0 && pblog('event', [opts.pagetype + '-' + opts.pageid, 'scroll', {
        'info': logArr,
        'sid': _sid || ''
      }]);
      return start;
    }
    /**
     * 初始计算
     */


    start = end = logShow();
    /**
     * 绑定滚动事件
     */

    var timer = null;

    window.onscroll = function () {
      timer && clearTimeout(timer);

      if (start > max) {
        return;
      }

      timer = setTimeout(logShow, 100);
    };
  };
}();