module.exports = function () {
  var $ = require('boxjs/dist/utils/_bdboxWrapper');

  var monitor = require('./monitor');

  var GIF_URI = '//m.baidu.com/static/searchbox/_analyze/f.gif';
  var SITE_ID = ''; // //白名单

  var WHITE_LIST = {
    'baidu.com': 1,
    'hao123.com': 1,
    'nuomi.com': 1,
    'iqiyi.com': 1,
    'qunar.com': 1,
    '0.0.1': 1
  };
  var W = window,
      P = W.top,
      D = document;
  var urlencode = encodeURIComponent;
  var hijack = monitor(GIF_URI, {
    customHandler: function (url) {
      return url + '&id=' + SITE_ID + '&u=' + urlencode(location.href);
    }
  });

  hijack.init = function (id, whitelist, monitorWrite) {
    SITE_ID = id;

    if (whitelist) {
      for (var i in whitelist) {
        WHITE_LIST[i] = whitelist[i];
      }
    }

    hiJackSniffer(); // if (monitorWrite) {
    //     hijack.write();
    // }
  }; // hijack.write = safeWrite;


  function report(arr, type) {
    var url = 'type=' + type + '&files=' + urlencode(files.join(','));
    return hijack.report(url);
  }

  function hiJackSniffer() {
    var files = $.$('script[src],iframe');
    var arr = [],
        s;

    for (var i = 0, len = files.length; i < len; i++) {
      s = files[i].src;

      if (WHITE_LIST[(RE_DOMAIN.exec(s) || [])[2]]) {} else {
        arr.push(s);
      }
    }

    if (arr.length) {
      return report(arr, 1);
    }

    arr = getParentUrl();

    if (arr && arr.length) {
      //被嵌入到iframe
      return report([arr], 2);
    }
  } // var RE_SCRIPTS = /<[script|iframe].*?src\=["']?([^"'\s>]+)/ig;


  var RE_DOMAIN = /(.+?)\.([^\/]+).+/; //修改document.write方法，实现安全write
  //安全document.write
  // function safeWrite() {
  //     var native_write = D.write;
  //     D.write = function(str) {
  //         try {
  //             var s, safes = [],
  //                 unkowns = [];
  //             while (s = RE_SCRIPTS.exec(str)) {
  //                 if (WHITE_LIST[(RE_DOMAIN.exec(s) || [])[2]]) {
  //                     safes.push(s);
  //                 } else {
  //                     unkowns.push(s);
  //                 }
  //             }
  //             if (unkowns.length > 0) {
  //                 report(unkowns, 3);
  //             }
  //             try {
  //                 native_write.call(this, str);
  //             } catch (ex) {
  //                 native_write(str);
  //             }
  //         } catch (ex) {
  //             native_write(str);
  //         }
  //     };
  // }

  function getParentUrl() {
    var url;

    if (P !== W) {
      try {
        url = P.location.href;
      } catch (e) {
        url = D.referrer;
      }
    }

    return url;
  }
  /**
   * 页面劫持监控
   * @memberOf Bdbox.monitor
   * @name  hijack
   * @author wangyongqing01
   * @version $Id: hijack.js 286585 2016-03-15 11:57:15Z wangyongqing01 $
   * @example
   * //id 监控id
   * //whitelist 白名单对象
   * //是否检测document.write
   * Bdbox.monitor.hijack('init',[id, whitelist, monitorWrite])
   *
   */


  return function () {
    hijack.main.apply(hijack, arguments);
  };
}();