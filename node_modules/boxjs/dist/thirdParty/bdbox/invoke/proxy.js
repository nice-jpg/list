module.exports = function () {
  var $ = require('boxjs/dist/utils/_bdboxWrapper'); //xbox用的moplus代理页面，它用无效
  //@author wangyongqing01
  //$Id: proxy.js 286585 2016-03-15 11:57:15Z wangyongqing01 $


  require('../io/xDomain');

  require('../moplus');

  var moplus = $.moplus(3.0);
  var xDomain = $.io.xDomain(); //添加接受moplus数据

  xDomain.on('minversion', function (mv) {
    if (mv) {
      moplus = $.moplus(mv);
    }
  }).on('getInfo', function (data) {
    var cbname = data._cbname;
    moplus.getInfo(function (data) {
      xDomain.send(cbname, data);
    });
  }).on('sendIntent', function (data) {
    var cbname = data._cbname;
    var intent = data.intent;

    if (/package=com.baidu(.+);/.test(intent)) {
      //包含自己的package，不替换
      moplus.sendIntent(intent, function (data) {
        xDomain.send(cbname, data);
      });
    } else {
      intent = intent.split(';');
      moplus.getHVersion(function (info) {
        if (info && info.version) {
          intent.splice(1, 0, 'package=' + info.name);
          intent = intent.join(';'); //发送moplus请求

          moplus.sendIntent(intent, function (data) {
            xDomain.send(cbname, data);
          });
        } else {
          //moplus不满足需求
          showUpdate();
        }
      });
    }
  });

  function showUpdate() {
    xDomain.send('showUpdate');
  }
}();